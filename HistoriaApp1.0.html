<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥æœ¬å² 2025 Deep Learning Pro+ (Ultra) 98th Master</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Orbitron:wght@400;700;900&family=Cinzel:wght@700&display=swap');
        
        :root {
            --bg-deep: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.85);
            --accent-primary: #6366f1;
            --accent-emerald: #10b981;
            --accent-rose: #f43f5e;
            --accent-amber: #f59e0b;
            --accent-cyan: #00f2ff;
            --text-main: #f8fafc;
        }

        body { font-family: 'Noto Sans JP', sans-serif; background-color: var(--bg-deep); color: var(--text-main); margin: 0; overflow-x: hidden; transition: background-color 0.5s ease; }
        .font-flashy { font-family: 'Orbitron', sans-serif; }
        .font-header { font-family: 'Cinzel', serif; }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); transition: background-color 0.5s ease; box-shadow: none !important; }
        
        .option-btn { 
            transition: all 0.2s; 
            background: rgba(255, 255, 255, 0.05); 
            padding: 0.85rem 1.2rem !important; 
            min-height: 3.5rem; 
            line-height: 1.4; 
            display: flex; 
            align-items: center; 
            justify-content: flex-start;
            text-align: left;
            font-size: 0.95rem; 
            border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 0.75rem; 
            width: 100%; 
            color: var(--text-main);
        }
        .option-btn:not(:disabled):hover { background: rgba(255, 255, 255, 0.1); transform: translateX(6px); border-color: var(--accent-primary); }
        
        .explanation-card { line-height: 1.6; border-left: 4px solid var(--accent-primary); }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .progress-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); transition: all 0.3s; }
        .dot-correct { background: var(--accent-emerald); }
        .dot-wrong { background: var(--accent-rose); }
        .dot-active { background: var(--accent-primary); transform: scale(1.3); }
        
        .group-header { background: rgba(255, 255, 255, 0.08); padding: 0.9rem 1.2rem; margin-bottom: 4px; cursor: pointer; font-weight: 900; font-size: 0.85rem; color: var(--text-main); display: flex; justify-content: space-between; border-radius: 12px; }
        .era-header { background: rgba(255, 255, 255, 0.03); border-left: 3px solid var(--accent-primary); padding: 0.75rem 1rem; cursor: pointer; display: flex; justify-content: space-between; margin: 4px 4px 4px 12px; border-radius: 6px; font-size: 0.85rem; }
        
        .expanded { max-height: 3000px !important; opacity: 1 !important; visibility: visible !important; padding-bottom: 0.5rem; }
        #custom-modal { display: none; position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 1.5rem; }
        #custom-modal.active { display: flex; }
        #registration-modal { display: none; position: fixed; inset: 0; z-index: 11000; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); align-items: center; justify-content: center; padding: 1rem; }
        #registration-modal.active { display: flex; }
        
        .neural-level-badge { background: linear-gradient(135deg, var(--accent-primary), #a855f7); color: white; padding: 2px 10px; border-radius: 4px; font-family: 'Orbitron', sans-serif; font-size: 10px; font-weight: 900; }
        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œæ¡ˆ1 (CSSã®ã¿ã§è§£æ±º) */
        .ranking-card { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            border-radius: 1rem; 
            padding: 0.75rem; 
            margin-top: 1rem; 
            box-shadow: none !important;
            overflow-x: auto; /* ã‚¹ãƒãƒ›ã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
            scrollbar-width: thin; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’æ§ãˆã‚ã« */
        }
        .ranking-card::-webkit-scrollbar { height: 4px; }
        .ranking-card::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        
        /* ä¸­ã®ã‚°ãƒªãƒƒãƒ‰ãŒé©åˆ‡ãªå¹…ã«ãªã‚‹ã‚ˆã†ã«å›ºå®š */
        .ranking-card .grid { 
            min-width: 740px; 
        }
        .goal-btn { transition: all 0.3s; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #94a3b8; font-family: 'Orbitron', sans-serif; box-shadow: none !important; }
        .goal-btn.active { background: var(--accent-primary); border-color: white; color: white; }
        
        /* ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å¾Œã®ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé‡‘è‰²ï¼‰ */
        @keyframes levelUpBlink {
            0%, 100% { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.8); }
            50% { color: #fcd34d; text-shadow: 0 0 20px rgba(252, 211, 77, 1); }
        }
        .level-up-blink {
            animation: levelUpBlink 1s ease-in-out infinite;
        }
        
        /* ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãŒè¿‘ã„ã¨ãã®ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç´«/ãƒ”ãƒ³ã‚¯ï¼‰ */
        @keyframes nearLevelUpBlink {
            0%, 100% { color: #a855f7; text-shadow: 0 0 8px rgba(168, 85, 247, 0.6); }
            50% { color: #ec4899; text-shadow: 0 0 15px rgba(236, 72, 153, 0.8); }
        }
        .near-level-up-blink {
            animation: nearLevelUpBlink 1.5s ease-in-out infinite;
        }

        .theme-swatch { width: 26px; height: 26px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; transition: transform 0.2s; position: relative; }
        .theme-swatch:hover { transform: scale(1.15); }
        .theme-swatch.active::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 10px; text-shadow: 0 0 2px black; }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ç”¨ç‰¹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
        footer {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.4) 0%, transparent 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.03);
            position: relative;
        }
        footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
        }
        .credit-glow-primary { color: var(--accent-primary); text-shadow: 0 0 8px rgba(99, 102, 241, 0.6); }
        .credit-glow-amber { color: var(--accent-amber); text-shadow: 0 0 8px rgba(245, 158, 11, 0.6); }
        .credit-glow-cyan { color: var(--accent-cyan); text-shadow: 0 0 8px rgba(0, 242, 255, 0.6); }
        .copyright-text { letter-spacing: 0.4em; opacity: 0.3; transition: opacity 0.3s; }
        footer:hover .copyright-text { opacity: 0.6; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- ç™»éŒ² -->
    <div id="registration-modal">
        <div class="glass-panel p-8 rounded-[2rem] max-w-sm w-full text-center space-y-6">
            <h3 class="text-xl font-black text-white italic font-flashy">Registration</h3>
            <p class="text-slate-400 text-sm">ã‚ãªãŸã®åå‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="space-y-2">
                <input id="user-name-input" type="text" class="w-full bg-black border border-indigo-500/50 rounded-xl p-3 text-center text-white outline-none font-bold" placeholder="SCHOLAR NAME">
                <p id="id-annotation" class="text-[10px] text-cyan-400 italic font-bold">â€»è¨˜éŒ²ã¯åå‰ã«ç´ä»˜ã‘ã•ã‚Œã¾ã™ã€‚</p>
            </div>
            <button id="register-btn" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-black uppercase hover:bg-indigo-500 transition-all">Connect to Hub</button>
        </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div id="custom-modal">
        <div class="glass-panel p-8 rounded-[2rem] max-w-sm w-full text-center space-y-6">
            <h3 id="modal-title" class="text-lg font-black text-white italic">Status</h3>
            <p id="modal-message" class="text-slate-300 text-sm leading-relaxed"></p>
            <button id="modal-close-btn" onclick="window.closeModal()" class="w-full bg-slate-800 text-slate-300 py-3 rounded-xl font-bold uppercase text-xs">Close</button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ -->
    <div id="app" class="max-w-4xl mx-auto w-full flex-grow px-3 py-3 md:p-8 flex flex-col">
        <div id="home-screen" class="space-y-6 md:space-y-8 fade-in">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div class="text-center md:text-left space-y-2">
                <h1 class="text-4xl md:text-7xl font-header tracking-tighter text-white">HISTORIA <span id="app-version-display" class="font-flashy text-2xl md:text-5xl" style="color: var(--accent-primary)">ULTRA 98th</span></h1>
                <div class="flex flex-wrap justify-center md:justify-start items-center gap-3">
                    <button id="active-user-display" class="bg-white/10 text-white text-[10px] px-4 py-1 rounded-full border border-white/20 font-black italic cursor-pointer transition-all hover:opacity-80">LOADING...</button>
                    <span id="neural-level-display" class="neural-level-badge">LV. 00</span>
                    <span id="current-rank-display" class="bg-white/10 text-white text-[10px] px-4 py-1 rounded-full border border-white/20 font-black italic">RANK --</span>
                    <span id="last-attempt-display" class="bg-cyan-500/20 text-cyan-200 text-[9px] px-3 py-1 rounded-full border border-cyan-400/40 font-medium"></span>
                    
                    <div class="flex items-center gap-2 ml-0 md:ml-4 pl-4 border-l border-white/10">
                        <label class="text-[8px] font-black text-amber-400 uppercase italic flex items-center gap-1"><i class="fas fa-bullseye"></i> Target</label>
                        <div class="flex gap-1">
                            <button onclick="setGoal(60)" id="goal-60" class="goal-btn px-2 py-1 rounded-md text-[9px] font-bold">60%</button>
                            <button onclick="setGoal(80)" id="goal-80" class="goal-btn px-2 py-1 rounded-md text-[9px] font-bold active">80%</button>
                            <button onclick="setGoal(100)" id="goal-100" class="goal-btn px-2 py-1 rounded-md text-[9px] font-bold">100%</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                <div class="lg:col-span-2 space-y-4">
                    <div class="glass-panel rounded-[1.5rem] md:rounded-[2.5rem] p-5 md:p-8 space-y-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-[10px] font-black uppercase flex items-center gap-2" style="color: var(--accent-primary)"><i class="fas fa-chart-area"></i> Neural Performance</h2>
                            <div class="flex gap-2">
                                <button onclick="window.toggleWeakList()" class="text-[9px] bg-rose-500/20 text-rose-300 px-3 py-1 rounded-full border border-rose-500/30 font-black uppercase"><i class="fas fa-search"></i> Weak Points</button>
                                <button onclick="window.syncAllFromSpreadsheet(false)" class="text-[9px] bg-white/10 text-white px-3 py-1 rounded-full border border-white/20 font-black uppercase"><i class="fas fa-sync-alt"></i> Sync</button>
                                <button id="cloud-sync-toggle-btn" class="text-[9px] bg-emerald-500/20 text-emerald-300 px-3 py-1 rounded-full border border-emerald-500/30 font-black uppercase"><i class="fas fa-palette"></i> Theme</button>
                            </div>
                        </div>
                        <div style="position:relative; height:240px; width:100%; margin-top: 10px;"><canvas id="performanceChart"></canvas></div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <div class="bg-slate-900/50 p-2 md:p-3 rounded-xl border border-white/5 text-center"><p class="text-[8px] text-slate-300 mb-0.5 uppercase font-bold">Total EXP</p><p id="total-neural-exp" class="text-sm md:text-lg font-flashy text-purple-400">0</p></div>
                            <div class="bg-slate-900/50 p-2 md:p-3 rounded-xl border border-white/5 text-center"><p class="text-[8px] text-slate-300 mb-0.5 uppercase font-bold">10å›å¹³å‡</p><p id="recent-accuracy" class="text-sm md:text-lg font-flashy text-orange-400">--%</p></div>
                            <div class="bg-slate-900/50 p-2 md:p-3 rounded-xl border border-white/5 text-center"><p class="text-[8px] text-slate-300 mb-0.5 uppercase font-bold">é€šç®—æ­£ç­”ç‡</p><p id="best-accuracy" class="text-sm md:text-lg font-flashy text-emerald-400">--%</p></div>
                            <div class="bg-slate-900/50 p-2 md:p-3 rounded-xl border border-white/5 text-center"><p class="text-[8px] text-slate-300 mb-0.5 uppercase font-bold">ç´¯è¨ˆæ¼”ç¿’</p><p id="total-sessions-count" class="text-sm md:text-lg font-flashy text-white">0</p></div>
                            <div class="bg-slate-900/50 p-2 md:p-3 rounded-xl border border-white/5 text-center"><p class="text-[8px] text-slate-300 mb-0.5 uppercase font-bold">ç¾åœ¨é€£ç¶š</p><p id="current-streak-display" class="text-sm md:text-lg font-flashy text-amber-400">0</p></div>
                            <div class="bg-slate-900/50 p-2 md:p-3 rounded-xl border border-white/5 text-center"><p class="text-[8px] text-slate-300 mb-0.5 uppercase font-bold">æœ€å¤§é€£ç¶š</p><p id="max-streak-display" class="text-sm md:text-lg font-flashy text-cyan-400">0</p></div>
                        </div>
                        <div id="ranking-card-wrapper" class="ranking-card space-y-2">
                            <h3 class="text-[10px] font-black text-amber-400 uppercase italic flex items-center gap-2 mb-3"><i class="fas fa-trophy"></i> Top Scholars</h3>
                            <div id="ranking-header" class="grid grid-cols-[30px_1fr_50px_35px_70px_70px_40px_50px_50px_140px] gap-3 items-center text-[8px] font-black text-white/40 uppercase border-b border-white/10 pb-1.5 mb-1">
                                <span>RK</span><span>NAME</span><span class="text-left">EXP</span><span class="text-left">LV</span><span class="text-left">10th Ave.</span><span class="text-left">ALL Ave.</span><span class="text-left">SESS</span><span class="text-left">CST</span><span class="text-left">MST</span><span class="text-left">LAST</span>
                            </div>
                            <div id="ranking-container" class="space-y-1"></div>
                        </div>
                    </div>
                    <div id="daily-stats-container" class="glass-panel rounded-[1.5rem] md:rounded-[2.5rem] p-4 md:p-6 space-y-3 max-h-[200px] overflow-y-auto"></div>
                </div>

                <div class="glass-panel rounded-[1.5rem] md:rounded-[2.5rem] p-6 md:p-8 space-y-6 flex flex-col">
                    <label class="text-[10px] font-black uppercase italic" style="color: var(--accent-primary)">Session Library</label>
                    <select id="level-select" class="w-full bg-slate-900 border border-white/10 rounded-xl p-3 text-xs font-bold outline-none" style="color: var(--accent-primary)" onchange="window.renderEraMenu()">
                        <option value="elementary">åˆç´š (åŸºç¤ãƒ»æ¨™æº–)</option>
                        <option value="intermediate">ä¸­ç´š (åŸºç¤ãƒ»æ¨™æº–ãƒ»å¿œç”¨)</option>
                        <option value="advanced">ä¸Šç´š (å…¨ãƒ¬ãƒ™ãƒ«æ¼”ç¿’)</option>
                        <option value="all" selected>ALL (åˆ¶é™ãªã—è¡¨ç¤º)</option>
                    </select>
                    <div id="era-menu-container" class="space-y-1.5 overflow-y-auto pr-1 flex-grow max-h-[600px]"></div>
                </div>
            </div>
            
            <div id="sync-area" class="hidden glass-panel rounded-[1.5rem] p-6 border-white/10 space-y-6 fade-in">
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-black text-emerald-400 uppercase italic flex items-center gap-2"><i class="fas fa-palette"></i> Visual Focus Modes</h3>
                        <span class="text-[8px] text-white/50 uppercase font-black">Scroll to explore</span>
                    </div>
                    <div id="theme-grid" class="grid grid-cols-10 gap-2 max-h-48 overflow-y-auto pr-2"></div>
                </div>
                <div class="space-y-2 pt-4 border-t border-white/5">
                    <h3 class="text-xs font-black text-white/50 uppercase italic flex items-center gap-2"><i class="fas fa-link"></i> Sync Manager</h3>
                    <input id="main-spreadsheet-url" type="text" class="w-full bg-black border border-slate-700 rounded p-2 text-[10px] text-emerald-300 outline-none" value="">
                    <button id="sync-all-btn-action" class="w-full bg-indigo-600 text-white text-[10px] py-3 rounded-lg font-black uppercase">Refresh & Sync Now</button>
                </div>
            </div>
        </div>

        <!-- æ¼”ç¿’ç”»é¢ãƒ»ãƒªã‚¶ãƒ«ãƒˆç”»é¢ãªã©ã¯å¤‰æ›´ãªã— -->
        <div id="quiz-screen" class="hidden space-y-4 fade-in">
            <div class="flex justify-between items-center px-1">
                <div class="grid grid-cols-3 gap-2 flex-1">
                    <div class="glass-panel p-2 rounded-xl text-center"><p class="text-[8px] text-slate-500 mb-0.5">Acc.</p><p id="current-accuracy" class="text-sm font-flashy" style="color: #818cf8;">0%</p></div>
                    <div class="glass-panel p-2 rounded-xl text-center"><p class="text-[8px] text-slate-500 mb-0.5">Streak</p><p id="current-streak" class="text-sm font-flashy text-amber-400">0</p></div>
                    <div class="glass-panel p-2 rounded-xl text-center"><p class="text-[8px] text-slate-500 mb-0.5">Prog.</p><p class="text-xs font-flashy text-white"><span id="q-current">1</span>/<span id="q-total">10</span></p></div>
                </div>
                <button id="abort-quiz-btn" onclick="window.abortQuiz()" class="ml-3 bg-rose-500/20 hover:bg-rose-500/30 text-rose-300 px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-rose-500/30 transition-all flex items-center gap-2">
                    <i class="fas fa-times"></i> QUIT
                </button>
            </div>
            <div id="dot-bar" class="flex justify-center gap-1 py-1"></div>
            <div class="glass-panel rounded-[1.5rem] p-6 relative overflow-hidden">
                <div id="goal-indicator" class="absolute top-0 left-0 h-1 transition-all duration-700" style="width: 0%; background: var(--accent-primary)"></div>
                <div class="space-y-4">
                    <div class="flex justify-between items-center"><span id="diff-badge" class="px-3 py-1 rounded-full text-[10px] font-black bg-white/5 text-slate-300 uppercase"></span><span id="q-history-stat" class="neural-level-badge text-[10px]">0% (0/0)</span></div>
                    <h2 id="question-text" class="text-lg md:text-2xl font-bold leading-snug text-white whitespace-pre-wrap text-left"></h2>
                    <div id="options-container" class="grid grid-cols-1 gap-2 pt-2"></div>
                </div>
            </div>
            <div id="feedback-area" class="hidden space-y-4 fade-in">
                <div class="flex flex-wrap items-center gap-4">
                    <div id="result-badge" class="px-5 py-2 rounded-full text-[10px] font-black uppercase w-fit text-white"></div>
                    <div id="voice-message" class="font-flashy text-xl md:text-3xl font-black italic tracking-tight" style="color: var(--accent-primary)"></div>
                </div>
                <div class="bg-white/5 rounded-[1.5rem] p-6 border border-white/10 shadow-inner"><div id="explanation-content" class="explanation-card text-slate-300 text-sm md:text-base whitespace-pre-line px-4"></div></div>
                <button id="next-btn-action" class="w-full bg-white text-slate-900 font-black py-4 rounded-2xl text-lg flex justify-center items-center gap-4 group">PROCEED <i class="fas fa-chevron-right group-hover:translate-x-1 transition-transform"></i></button>
            </div>
        </div>

        <div id="result-screen" class="hidden space-y-8 fade-in py-8">
            <div class="glass-panel rounded-[2rem] p-10 text-center space-y-8 border-white/10 relative overflow-hidden">
                <div id="final-icon" class="text-6xl mb-4">ğŸ‘‘</div>
                <h2 class="text-2xl md:text-5xl font-flashy tracking-tighter uppercase italic text-center">Neural Sync Complete</h2>
                <div class="space-y-3">
                    <p id="level-up-msg" class="text-amber-400 font-flashy text-xl md:text-3xl animate-pulse hidden">LEVEL UP! CONGRATULATIONS!</p>
                    <p id="goal-eval-msg" class="text-[10px] font-black uppercase tracking-[0.3em] mb-2"></p>
                    <p id="final-praise" class="font-flashy text-xs md:text-lg uppercase tracking-[0.3em]" style="color: var(--accent-primary)"></p>
                    <p id="final-praise-jp" class="text-indigo-200 font-bold text-lg md:text-2xl mt-2 px-4 text-left"></p>
                    <p id="final-message" class="text-slate-400 text-sm leading-relaxed max-w-lg mx-auto italic"></p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-900/90 p-4 rounded-xl border-l-4" style="border-color: var(--accent-primary)"><p class="text-[8px] text-slate-500 font-black uppercase mb-1">Accuracy</p><p class="text-2xl font-flashy" style="color: var(--accent-primary)"><span id="final-score">0</span>%</p></div>
                    <div class="bg-slate-900/90 p-4 rounded-xl border-l-4 border-amber-500"><p class="text-[8px] text-slate-500 font-black uppercase mb-1">EXP Gained</p><p id="final-exp-gained" class="text-2xl font-flashy text-amber-400">0</p></div>
                </div>
                <button onclick="window.showHome()" class="w-full text-white font-black py-4 rounded-2xl text-lg uppercase tracking-widest" style="background: var(--accent-primary)">Back to Hub</button>
            </div>
        </div>
    </div>

    <!-- ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="mt-auto pt-16 pb-12 text-center overflow-hidden">
        <div class="max-w-4xl mx-auto px-6">
            <p class="copyright-text font-flashy text-[8px] md:text-[9px] uppercase mb-6 text-white/40">
                &copy; 2025 NEURAL HISTORY SYSTEMS | <span class="text-indigo-400/60">HIGH SPEC EDITION</span> | ALL RIGHTS RESERVED.
            </p>
            
            <div class="credit-badge font-flashy text-[10px] md:text-[11px] tracking-[0.2em] uppercase font-black italic flex flex-wrap justify-center items-center gap-y-3 gap-x-4">
                <div class="flex items-center gap-1">
                    <span class="text-white/20 text-[8px]">CREATED BY</span> 
                    <span class="credit-glow-primary px-2 py-0.5 border border-indigo-500/20 rounded bg-indigo-500/5">Myo-n</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-white/20 text-[8px]">USING</span> 
                    <span class="credit-glow-amber">ChatGPT 5.2</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-white/20 text-[8px]">AND</span> 
                    <span class="credit-glow-cyan">Gemini 3.0</span>
                </div>
            </div>

            <!-- è£…é£¾çš„ãªãƒ©ã‚¤ãƒ³ -->
            <div class="mt-8 flex justify-center gap-1 opacity-20">
                <div class="w-1 h-1 bg-white rounded-full"></div>
                <div class="w-12 h-[1px] bg-white self-center"></div>
                <div class="w-1 h-1 bg-white rounded-full"></div>
            </div>
        </div>
    </footer>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆéƒ¨åˆ†ã¯ä»¥å‰ã®ã‚‚ã®ã‚’ç¶™ç¶šã—ã¦ä½¿ç”¨ -->
    <script>
         const FIXED_GAS_URL = "https://script.google.com/macros/s/AKfycbzNbTGroVFzm5s9k6iaoG_BquF8aF0-LaApT28dD0Py4UpTnnIuRtNSyY0mGpHrHtK2/exec";
        const FIXED_SPREADSHEET_URL = "https://docs.google.com/spreadsheets/d/1IxlE8Kj4NJUlNo1XmLoO6z1_dFXhYVy6AacSWUMgfPY/edit";

        let USER_NAME = "";
        let masterDataTotal = [];
        let quizData = []; let currentIdx = 0; let score = 0; let streak = 0;
        let canAnswer = true; let chartInstance = null;
        let sessionAnswers = [];
        let isRankingPublic = true; // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¬é–‹è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å…¬é–‹ï¼‰
        let currentSessionEra = ""; let currentSessionRangeLabel = "";
        let userHistory = [];
        let questionStats = {};
        let rankingData = [];
        let selectedGoal = 80;

        const THEMES = {
            modeA: { bg: '#0f172a', panel: 'rgba(30, 41, 59, 0.85)', accent: '#6366f1', text: '#f8fafc' },
            modeB: { bg: '#064e3b', panel: 'rgba(6, 78, 59, 0.8)', accent: '#10b981', text: '#ecfdf5' },
            modeC: { bg: '#450a0a', panel: 'rgba(127, 29, 29, 0.7)', accent: '#f43f5e', text: '#fff1f2' },
            modeD: { bg: '#18181b', panel: 'rgba(39, 39, 42, 0.9)', accent: '#94a3b8', text: '#f4f4f5' },
            modeE: { bg: '#431407', panel: 'rgba(124, 45, 18, 0.8)', accent: '#f59e0b', text: '#fff7ed' },
            modeF: { bg: '#083344', panel: 'rgba(22, 78, 99, 0.8)', accent: '#00f2ff', text: '#ecfeff' },
            modeG: { bg: '#2e1065', panel: 'rgba(76, 29, 149, 0.8)', accent: '#a855f7', text: '#f5f3ff' },
            modeH: { bg: '#1e1b4b', panel: 'rgba(49, 46, 129, 0.8)', accent: '#fbbf24', text: '#fffbeb' },
            modeI: { bg: '#000000', panel: 'rgba(17, 24, 39, 0.9)', accent: '#ec4899', text: '#fdf2f8' },
            modeJ: { bg: '#022c22', panel: 'rgba(20, 83, 45, 0.8)', accent: '#4ade80', text: '#f0fdf4' },
            t11: { bg: '#fdf2f8', panel: 'rgba(255, 255, 255, 0.9)', accent: '#db2777', text: '#831843' },
            t12: { bg: '#f5f3ff', panel: 'rgba(255, 255, 255, 0.9)', accent: '#7c3aed', text: '#4c1d95' },
            t13: { bg: '#ecfeff', panel: 'rgba(255, 255, 255, 0.9)', accent: '#0891b2', text: '#164e63' },
            t14: { bg: '#fff7ed', panel: 'rgba(255, 255, 255, 0.9)', accent: '#ea580c', text: '#7c2d12' },
            t15: { bg: '#f0f9ff', panel: 'rgba(255, 255, 255, 0.9)', accent: '#0284c7', text: '#0c4a6e' },
            t16: { bg: '#020617', panel: 'rgba(15, 23, 42, 0.85)', accent: '#38bdf8', text: '#f8fafc' },
            t17: { bg: '#111827', panel: 'rgba(31, 41, 55, 0.8)', accent: '#60a5fa', text: '#f3f4f6' },
            t18: { bg: '#171717', panel: 'rgba(38, 38, 38, 0.85)', accent: '#a3a3a3', text: '#ffffff' },
            t19: { bg: '#0c0a09', panel: 'rgba(28, 25, 23, 0.8)', accent: '#d6d3d1', text: '#fafaf9' },
            t20: { bg: '#052e16', panel: 'rgba(6, 78, 59, 0.7)', accent: '#22c55e', text: '#f0fdf4' },
            t21: { bg: '#2d1616', panel: 'rgba(69, 10, 10, 0.8)', accent: '#ef4444', text: '#fee2e2' },
            t22: { bg: '#161d2d', panel: 'rgba(15, 23, 42, 0.8)', accent: '#3b82f6', text: '#eff6ff' },
            t23: { bg: '#1d2d16', panel: 'rgba(20, 83, 45, 0.75)', accent: '#16a34a', text: '#f0fdf4' },
            t24: { bg: '#2d2d16', panel: 'rgba(66, 66, 30, 0.8)', accent: '#ca8a04', text: '#fefce8' },
            t25: { bg: '#22162d', panel: 'rgba(46, 16, 101, 0.8)', accent: '#9333ea', text: '#faf5ff' },
            t26: { bg: '#000000', panel: 'rgba(20, 20, 20, 0.9)', accent: '#00ff41', text: '#ffffff' },
            t27: { bg: '#0f0514', panel: 'rgba(30, 10, 40, 0.8)', accent: '#ff00ff', text: '#ffffff' },
            t28: { bg: '#050f14', panel: 'rgba(10, 30, 40, 0.8)', accent: '#00ffff', text: '#ffffff' },
            t29: { bg: '#140f05', panel: 'rgba(40, 30, 10, 0.8)', accent: '#ffff00', text: '#ffffff' },
            t30: { bg: '#140505', panel: 'rgba(40, 10, 10, 0.8)', accent: '#ff0000', text: '#ffffff' },
            t31: { bg: '#fff1f2', panel: 'rgba(255, 255, 255, 0.85)', accent: '#fb7185', text: '#881337' },
            t32: { bg: '#f0fdf4', panel: 'rgba(255, 255, 255, 0.85)', accent: '#4ade80', text: '#064e3b' },
            t33: { bg: '#fff7ed', panel: 'rgba(255, 255, 255, 0.85)', accent: '#f97316', text: '#7c2d12' },
            t34: { bg: '#f8fafc', panel: 'rgba(255, 255, 255, 0.85)', accent: '#94a3b8', text: '#0f172a' },
            t35: { bg: '#faf5ff', panel: 'rgba(255, 255, 255, 0.85)', accent: '#a855f7', text: '#3b0764' },
            t36: { bg: '#1e293b', panel: 'rgba(51, 65, 85, 0.8)', accent: '#38bdf8', text: '#f1f5f9' },
            t37: { bg: '#312e81', panel: 'rgba(67, 56, 202, 0.8)', accent: '#818cf8', text: '#e0e7ff' },
            t38: { bg: '#4c1d95', panel: 'rgba(91, 33, 182, 0.8)', accent: '#c084fc', text: '#f5f3ff' },
            t39: { bg: '#831843', panel: 'rgba(157, 23, 77, 0.8)', accent: '#f472b6', text: '#fdf2f8' },
            t40: { bg: '#7c2d12', panel: 'rgba(154, 52, 18, 0.8)', accent: '#fb923c', text: '#fff7ed' },
            t41: { bg: '#164e63', panel: 'rgba(21, 94, 117, 0.8)', accent: '#22d3ee', text: '#ecfeff' },
            t42: { bg: '#065f46', panel: 'rgba(5, 150, 105, 0.8)', accent: '#34d399', text: '#ecfdf5' },
            t43: { bg: '#3f6212', panel: 'rgba(101, 163, 13, 0.8)', accent: '#a3e635', text: '#f7fee7' },
            t44: { bg: '#854d0e', panel: 'rgba(202, 138, 4, 0.8)', accent: '#facc15', text: '#fefce8' },
            t45: { bg: '#92400e', panel: 'rgba(180, 83, 9, 0.8)', accent: '#fbbf24', text: '#fffbeb' },
            t46: { bg: '#991b1b', panel: 'rgba(185, 28, 28, 0.8)', accent: '#f87171', text: '#fef2f2' },
            t47: { bg: '#374151', panel: 'rgba(75, 85, 99, 0.8)', accent: '#9ca3af', text: '#f9fafb' },
            t48: { bg: '#0f172a', panel: 'rgba(30, 41, 59, 0.8)', accent: '#f472b6', text: '#f8fafc' },
            t49: { bg: '#1e1b4b', panel: 'rgba(49, 46, 129, 0.8)', accent: '#2dd4bf', text: '#f0fdfa' },
            t50: { bg: '#111827', panel: 'rgba(31, 41, 55, 0.8)', accent: '#fcd34d', text: '#fffbeb' }
        };

        const getEl = (id) => document.getElementById(id);
        const setOnClick = (id, fn) => { const el = getEl(id); if (el) el.onclick = fn; };

        window.applyTheme = (modeId) => {
            const t = THEMES[modeId]; if (!t) return;
            const root = document.documentElement;
            root.style.setProperty('--bg-deep', t.bg);
            root.style.setProperty('--panel-bg', t.panel);
            root.style.setProperty('--accent-primary', t.accent);
            root.style.setProperty('--text-main', t.text);
            Object.keys(THEMES).forEach(m => { const swatch = getEl(`swatch-${m}`); if (swatch) swatch.classList.remove('active'); });
            const activeSwatch = getEl(`swatch-${modeId}`); if (activeSwatch) activeSwatch.classList.add('active');
            localStorage.setItem('historia_theme_mode', modeId);
            if (chartInstance) renderPerformanceChart(userHistory);
        };

        window.setGoal = (pct) => {
            selectedGoal = pct;
            ['60','80','100'].forEach(g => { const btn = getEl(`goal-${g}`); if (btn) btn.classList.remove('active'); });
            const activeBtn = getEl(`goal-${pct}`); if (activeBtn) activeBtn.classList.add('active');
        };

        window.closeModal = () => {
            const modal = getEl('custom-modal');
            if (modal) modal.classList.remove('active');
        };

        async function fetchWithRetry(url, options = {}, retries = 5, backoff = 1000) {
            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                return await res.json();
            } catch (err) {
                if (retries > 0) { await new Promise(r => setTimeout(r, backoff)); return fetchWithRetry(url, options, retries - 1, backoff * 2); }
                throw err;
            }
        }
        
        function formatAccStr(val) {
            if (val === null || val === undefined || val === "" || val === "--%") return "--%";
            let s = String(val).replace('%', '').trim();
            let n = parseFloat(s);
            if (isNaN(n)) return "--%";
            if (n <= 1.0 && n > 0 && String(val).indexOf('%') === -1) n *= 100;
            return Math.round(n) + "%";
        }

        function initUserInfo() { 
            USER_NAME = localStorage.getItem('historia_user_name'); 
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«å€¤ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¬é–‹ï¼ˆtrueï¼‰
            const storedPublic = localStorage.getItem('historia_ranking_public');
            isRankingPublic = storedPublic === null ? true : storedPublic === 'true';
            if (!USER_NAME) { 
                getEl('registration-modal').classList.add('active'); 
            } else { 
                updateUserDisplay(); 
            } 
        }
        function updateUserDisplay() { 
            const displayEl = getEl('active-user-display');
            if (displayEl) {
                // åå‰ã®æ¨ªã«å…¬é–‹/éå…¬é–‹ã‚’å°ã•ãè‹±èªã§è¡¨ç¤º
                const publicLabel = isRankingPublic ? '<span class="text-[7px] text-amber-400/70 font-normal ml-1">PUBLIC</span>' : '<span class="text-[7px] text-slate-300/80 font-normal ml-1">PRIVATE</span>';
                displayEl.innerHTML = USER_NAME + publicLabel;
                // å…¬é–‹è¨­å®šã«å¿œã˜ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´ï¼ˆå…‰ã‚‰ã›ã‚‹=å…¬é–‹ï¼‰
                if (isRankingPublic) {
                    displayEl.classList.add('bg-amber-500/30', 'border-amber-400/50', 'text-amber-200', 'shadow-lg', 'shadow-amber-500/50');
                    displayEl.classList.remove('bg-white/10', 'border-white/20', 'text-white');
                } else {
                    displayEl.classList.add('bg-white/10', 'border-white/20', 'text-white');
                    displayEl.classList.remove('bg-amber-500/30', 'border-amber-400/50', 'text-amber-200', 'shadow-lg', 'shadow-amber-500/50');
                }
            }
        }
        function toggleRankingPublic() {
            isRankingPublic = !isRankingPublic;
            localStorage.setItem('historia_ranking_public', isRankingPublic.toString());
            updateUserDisplay();
        }
        
        setOnClick('register-btn', () => { const val = getEl('user-name-input').value.trim(); if (!val) return; USER_NAME = val; localStorage.setItem('historia_user_name', USER_NAME); getEl('registration-modal').classList.remove('active'); updateUserDisplay(); window.syncAllFromSpreadsheet(true); });
        setOnClick('active-user-display', toggleRankingPublic);

        async function logDetailedResultsToSpreadsheet(pct, correct, total) {
            if (!FIXED_GAS_URL) return;
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰URLã‚’å–å¾—
            const urlInput = getEl('main-spreadsheet-url');
            const spreadsheetUrl = urlInput && urlInput.value ? urlInput.value : FIXED_SPREADSHEET_URL;
            const sid = spreadsheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/)?.[1];
            if (!sid) return;
            const payload = { action: 'logAll', spreadsheetId: sid, dbName: USER_NAME, userId: USER_NAME, summaryAccuracy: pct + '%', summaryScore: `${correct}/${total}`, summaryRange: currentSessionRangeLabel, summaryEra: currentSessionEra, details: JSON.stringify(quizData.map((q, idx) => ({ era: q.era, qIdx: q.id.split('-').pop(), attemptNum: (questionStats[q.id]?.total || 1), result: sessionAnswers[idx] ? "â—‹" : "Ã—" }))), gainedExp: correct, finalStreak: streak, isPublic: isRankingPublic ? '1' : '0' };
            try { await fetchWithRetry(`${FIXED_GAS_URL}?${new URLSearchParams(payload).toString()}`); window.syncAllFromSpreadsheet(true); } catch (e) {}
        }

        function updateStatsUI() {
            try {
                const sorted = [...userHistory].sort((a,b) => b.timestamp - a.timestamp);
                const latest = sorted[0];
                if (latest) {
                    const totalExp = latest.totalExp || 0;
                    const expEl = getEl('total-neural-exp');
                    if (expEl) {
                        expEl.innerText = totalExp;
                        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—åˆ¤å®šã¨ç‚¹æ»…å‡¦ç†
                        const lv = Math.floor(totalExp / 10);
                        const nextLevelExp = (lv + 1) * 10;
                        const remainingExp = nextLevelExp - totalExp;
                        const isLevelUpJustNow = (totalExp % 10 === 0 && totalExp > 0);
                        const isNearLevelUp = remainingExp <= 5 && remainingExp > 0;
                        
                        // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                        expEl.classList.remove('level-up-blink', 'near-level-up-blink');
                        
                        if (isLevelUpJustNow) {
                            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ç›´å¾Œï¼šé‡‘è‰²ã§ç‚¹æ»…
                            expEl.classList.add('level-up-blink');
                        } else if (isNearLevelUp) {
                            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãŒè¿‘ã„ï¼šç´«/ãƒ”ãƒ³ã‚¯ã§ç‚¹æ»…
                            expEl.classList.add('near-level-up-blink');
                        }
                    }
                    if (getEl('recent-accuracy')) getEl('recent-accuracy').innerText = formatAccStr(latest.avg10);
                    if (getEl('best-accuracy')) getEl('best-accuracy').innerText = formatAccStr(latest.overallAcc);
                    if (getEl('total-sessions-count')) getEl('total-sessions-count').innerText = userHistory.length;
                    const lv = Math.floor(totalExp / 10);
                    if (getEl('neural-level-display')) getEl('neural-level-display').innerText = `LV. ${String(lv).padStart(2, '0')}`;
                } else {
                    // å±¥æ­´ãŒãªã„å ´åˆã®åˆæœŸå€¤
                    if (getEl('total-neural-exp')) getEl('total-neural-exp').innerText = '0';
                    if (getEl('recent-accuracy')) getEl('recent-accuracy').innerText = '--%';
                    if (getEl('best-accuracy')) getEl('best-accuracy').innerText = '--%';
                    if (getEl('total-sessions-count')) getEl('total-sessions-count').innerText = '0';
                    if (getEl('neural-level-display')) getEl('neural-level-display').innerText = 'LV. 00';
                }
                
                // é€£ç¶šæ­£è§£æ•°ã‚’è¡¨ç¤ºï¼ˆGASã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å–å¾—ã—ãŸå€¤ã‚’ä½¿ç”¨ï¼‰
                const currentStreak = window.currentStreak || 0;
                const maxStreak = window.maxStreak || 0;
                
                if (getEl('current-streak-display')) getEl('current-streak-display').innerText = currentStreak;
                if (getEl('max-streak-display')) getEl('max-streak-display').innerText = maxStreak;
                
                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ãƒ©ãƒ³ã‚¯ã‚’è¡¨ç¤ºï¼ˆåˆ†æ¯ã‚‚å«ã‚ã‚‹ï¼‰
                if (rankingData && rankingData.length > 0) {
                    const myRank = rankingData.findIndex(r => r.name === USER_NAME) + 1;
                    const totalRanking = rankingData.length;
                    const myData = rankingData.find(r => r.name === USER_NAME);
                    
                    if (getEl('current-rank-display')) {
                        const rankEl = getEl('current-rank-display');
                        // ãƒ©ãƒ³ã‚¯ã«å¿œã˜ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´ï¼ˆãƒˆãƒƒãƒ—10ã¾ã§å¼·èª¿ã€ä¸Šä½50%ä»¥ä¸Šã‚‚ç›®ç«‹ãŸã›ã‚‹ï¼‰
                        rankEl.className = 'text-[10px] px-4 py-1 rounded-full border font-black italic';
                        const isTop50Percent = myRank > 0 && myRank <= Math.ceil(totalRanking / 2);
                        
                        if (myRank > 0 && myRank <= 10) {
                            // ãƒˆãƒƒãƒ—10ã¾ã§ã¯é †ä½ã«å¿œã˜ãŸå¼·èª¿
                            if (myRank === 1) {
                                rankEl.className += ' bg-gradient-to-r from-yellow-500/40 to-amber-500/40 border-yellow-400/60 text-yellow-200 shadow-lg shadow-yellow-500/50';
                            } else if (myRank === 2) {
                                rankEl.className += ' bg-gradient-to-r from-slate-400/40 to-slate-500/40 border-slate-300/60 text-slate-100 shadow-lg shadow-slate-400/50';
                            } else if (myRank === 3) {
                                rankEl.className += ' bg-gradient-to-r from-amber-600/40 to-orange-600/40 border-amber-500/60 text-amber-200 shadow-lg shadow-amber-600/50';
                            } else if (myRank <= 5) {
                                rankEl.className += ' bg-gradient-to-r from-purple-500/30 to-indigo-500/30 border-purple-400/50 text-purple-200 shadow-md shadow-purple-500/40';
                            } else if (myRank <= 10) {
                                rankEl.className += ' bg-gradient-to-r from-blue-500/25 to-cyan-500/25 border-blue-400/40 text-blue-200 shadow shadow-blue-500/30';
                            }
                        } else if (isTop50Percent) {
                            // 10ä½ã‚ˆã‚Šä¸‹ä½ã§ä¸Šä½50%ä»¥ä¸Šã¯ç›®ç«‹ãŸã›ã‚‹ï¼ˆ3ä½ã»ã©ã§ã¯ãªã„ãŒï¼‰
                            rankEl.className += ' bg-gradient-to-r from-green-500/20 to-emerald-500/20 border-green-400/30 text-green-200';
                        } else {
                            rankEl.className += ' bg-white/10 border-white/20 text-white';
                        }
                        // ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã¯æ—¥ä»˜ã‚’å«ã‚ãªã„
                        rankEl.innerText = myRank > 0 ? `RANK ${myRank} / ${totalRanking}` : `RANK -- / ${totalRanking}`;
                    }
                    
                    // æœ€çµ‚å–ã‚Šçµ„ã¿æ—¥æ™‚ã‚’è¡¨ç¤ºï¼ˆãƒ©ãƒ³ã‚¯è¡¨ç¤ºã®å³å´ã«åˆ¥è¦ç´ ã¨ã—ã¦ï¼‰
                    if (getEl('last-attempt-display')) {
                        const lastEl = getEl('last-attempt-display');
                        let lastDate = null;
                        let lastDateStr = '';
                        
                        if (myData && myData.lastAttemptDate) {
                            lastDateStr = myData.lastAttemptDate;
                            // "yyyy/MM/dd HH:mm:ss"å½¢å¼ã‹ã‚‰æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                            const dateTimeParts = lastDateStr.split(' ');
                            if (dateTimeParts.length >= 1) {
                                const dateParts = dateTimeParts[0].split('/');
                                if (dateParts.length >= 3) {
                                    lastDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                                    if (dateTimeParts.length >= 2) {
                                        const timeParts = dateTimeParts[1].split(':');
                                        if (timeParts.length >= 3) {
                                            lastDate.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), parseInt(timeParts[2]));
                                        }
                                    }
                                }
                            }
                        } else {
                            // å±¥æ­´ãƒ­ã‚°ã‹ã‚‰æœ€æ–°ã®æ—¥æ™‚ã‚’å–å¾—
                            const sortedHistory = [...userHistory].sort((a, b) => b.timestamp - a.timestamp);
                            if (sortedHistory.length > 0 && sortedHistory[0].timestamp) {
                                lastDate = new Date(sortedHistory[0].timestamp);
                                const year = lastDate.getFullYear();
                                const month = String(lastDate.getMonth() + 1).padStart(2, '0');
                                const day = String(lastDate.getDate()).padStart(2, '0');
                                const hours = String(lastDate.getHours()).padStart(2, '0');
                                const minutes = String(lastDate.getMinutes()).padStart(2, '0');
                                const seconds = String(lastDate.getSeconds()).padStart(2, '0');
                                lastDateStr = `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
                            }
                        }
                        
                        if (lastDate) {
                            const now = new Date();
                            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            const lastDay = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
                            const diffTime = today - lastDay;
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            
                            let daysAgoText = '';
                            if (diffDays === 0) {
                                daysAgoText = 'Today';
                            } else if (diffDays === 1) {
                                daysAgoText = '1 day ago';
                            } else {
                                daysAgoText = `${diffDays} days ago`;
                            }
                            
                            if (!lastDateStr) {
                                const year = lastDate.getFullYear();
                                const month = String(lastDate.getMonth() + 1).padStart(2, '0');
                                const day = String(lastDate.getDate()).padStart(2, '0');
                                const hours = String(lastDate.getHours()).padStart(2, '0');
                                const minutes = String(lastDate.getMinutes()).padStart(2, '0');
                                const seconds = String(lastDate.getSeconds()).padStart(2, '0');
                                lastDateStr = `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
                            }
                            
                            // é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—ï¼ˆã“ã“ã§è¨ˆç®—ã—ã¦Lastè¡¨ç¤ºã®å³ã«è¡¨ç¤ºï¼‰
                            let consecutiveDays = 0;
                            const dailyStatsForStreak = {};
                            userHistory.forEach(h => {
                                if (h.timestamp) {
                                    const date = new Date(h.timestamp);
                                    const dateKey = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                                    dailyStatsForStreak[dateKey] = true;
                                }
                            });
                            const sortedDatesForStreak = Object.keys(dailyStatsForStreak).sort((a, b) => new Date(b) - new Date(a));
                            const todayForStreak = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            let checkDateForStreak = new Date(todayForStreak);
                            
                            for (const dateStr of sortedDatesForStreak) {
                                const date = new Date(dateStr);
                                const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                                const diffTime = checkDateForStreak - dateOnly;
                                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                                
                                if (diffDays === 0 || diffDays === 1) {
                                    consecutiveDays++;
                                    checkDateForStreak = new Date(dateOnly);
                                } else {
                                    break;
                                }
                            }
                            
                            lastEl.innerHTML = `Last: ${lastDateStr} <span class="text-cyan-300 font-bold">(${daysAgoText})</span> <span class="text-cyan-400 font-bold ml-2">${consecutiveDays} days streak</span>`;
                            lastEl.style.display = '';
                        } else {
                            lastEl.style.display = 'none';
                        }
                    }
                    
                } else {
                    if (getEl('current-rank-display')) {
                        getEl('current-rank-display').innerText = 'RANK --';
                        getEl('current-rank-display').className = 'bg-white/10 text-white text-[10px] px-4 py-1 rounded-full border border-white/20 font-black italic';
                    }
                    if (getEl('last-attempt-display')) {
                        getEl('last-attempt-display').style.display = 'none';
                    }
                }

                const rankCont = getEl('ranking-container');
                const rankWrapper = getEl('ranking-card-wrapper');
                const rankHeader = getEl('ranking-header');
                
                if (rankCont) { 
                    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å¸¸ã«è¡¨ç¤ºï¼ˆãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã§ã‚‚ï¼‰
                    if (rankWrapper) rankWrapper.style.display = '';
                    if (rankHeader) rankHeader.style.display = 'grid';
                    
                    if (rankingData && rankingData.length > 0) {
                        rankCont.innerHTML = rankingData.map((r, i) => {
                            const rLv = Math.floor((r.exp || 0) / 10);
                            const isMe = r.name === USER_NAME;
                            // æœ€çµ‚å–ã‚Šçµ„ã¿æ—¥ï¼ˆuserHistoryã‹ã‚‰å–å¾—ã€å¹´æœˆæ—¥ã®ã¿ã€æ™‚åˆ»ã¯ã‚«ãƒƒãƒˆï¼‰
                            let lastDateDisplay = '--';
                            // è‡ªåˆ†ã®å ´åˆã¯userHistoryã‹ã‚‰å–å¾—ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                            if (isMe && userHistory && userHistory.length > 0) {
                                const sortedUserHistory = [...userHistory].sort((a, b) => b.timestamp - a.timestamp);
                                const latestEntry = sortedUserHistory[0];
                                if (latestEntry && latestEntry.timestamp) {
                                    const date = new Date(latestEntry.timestamp);
                                    const year = date.getFullYear();
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    lastDateDisplay = `${year}/${month}/${day}`;
                                }
                            }
                            // rankingDataã‹ã‚‰ã‚‚è©¦ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                            if (lastDateDisplay === '--' && r.lastAttemptDate) {
                                const dateTimeStr = String(r.lastAttemptDate);
                                const dateTimeParts = dateTimeStr.split(' ');
                                if (dateTimeParts.length >= 1) {
                                    lastDateDisplay = dateTimeParts[0]; // æ—¥ä»˜éƒ¨åˆ†ã®ã¿ï¼ˆæ™‚åˆ»ã¯ã‚«ãƒƒãƒˆï¼‰
                                }
                            }
                            return `<div class="grid grid-cols-[30px_1fr_50px_35px_70px_70px_40px_50px_50px_140px] gap-3 items-center text-[10px] py-1.5 border-b border-white/5 last:border-0 ${isMe ? 'text-amber-300 bg-white/5 font-bold' : 'text-slate-200'}">
                                <span class="opacity-40 font-black">${i+1}</span>
                                <span class="truncate font-bold">${r.name}</span>
                                <span class="text-left font-flashy text-[9px] text-indigo-400">${r.exp || 0}</span>
                                <span class="text-left font-flashy text-[9px] text-emerald-400">${String(rLv).padStart(2,'0')}</span>
                                <span class="text-left font-flashy text-[9px] text-orange-400">${r.avg10 || '--%'}</span>
                                <span class="text-left font-flashy text-[9px] text-cyan-400">${r.overall || '--%'}</span>
                                <span class="text-left font-flashy opacity-60 text-[9px]">${r.count || 0}</span>
                                <span class="text-left font-flashy text-[9px] text-amber-400">${(r.currentStreak !== undefined && r.currentStreak !== null) ? r.currentStreak : '--'}</span>
                                <span class="text-left font-flashy text-[9px] text-cyan-400">${(r.maxStreak !== undefined && r.maxStreak !== null) ? r.maxStreak : '--'}</span>
                                <span class="text-left font-flashy text-[9px] text-slate-200 opacity-90">${lastDateDisplay}</span>
                            </div>`;
                        }).join('');
                    } else {
                        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                        rankCont.innerHTML = '<div class="text-center text-[9px] text-slate-500/70 py-4 italic">No ranking data available</div>';
                    }
                    
                    // æ—¥ä»˜ã”ã¨ã®å•é¡Œæ•°ã¨æ­£ç­”ç‡ã‚’è¨ˆç®—ãƒ»è¡¨ç¤ºï¼ˆåˆ¥ã®æ å†…ã§ä¸€ç•ªä¸‹ã«é…ç½®ï¼‰
                    const dailyStatsEl = getEl('daily-stats-container');
                    if (dailyStatsEl) {
                        if (userHistory && userHistory.length > 0) {
                            // æ—¥ä»˜ã”ã¨ã«å•é¡Œæ•°ã¨æ­£è§£æ•°ã‚’é›†è¨ˆ
                            const dailyStats = {};
                            userHistory.forEach(h => {
                                if (h.timestamp) {
                                    const date = new Date(h.timestamp);
                                    const dateKey = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                                    if (!dailyStats[dateKey]) {
                                        dailyStats[dateKey] = { count: 0, totalQ: 0, correctQ: 0, gainedExp: 0 };
                                    }
                                    dailyStats[dateKey].count += 1;
                                    dailyStats[dateKey].totalQ += (h.totalQ || 10);
                                    dailyStats[dateKey].correctQ += (h.correctCount || 0);
                                    // ç²å¾—EXPã¯æ­£è§£æ•°ã¨åŒã˜ï¼ˆgainedExp: correctï¼‰
                                    dailyStats[dateKey].gainedExp += (h.correctCount || 0);
                                }
                            });
                            
                            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                            const sortedDailyStats = Object.entries(dailyStats).sort((a, b) => {
                                return new Date(b[0]) - new Date(a[0]);
                            });
                            
                            // è¡¨ç¤ºã‚’æ§‹ç¯‰
                            let html = `<div class="text-[10px] font-black uppercase italic mb-3" style="color: var(--accent-primary)">Daily Stats</div>`;
                            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆãƒ©ãƒ™ãƒ«ï¼‰
                            html += `<div class="grid grid-cols-[80px_1fr_1fr_1fr_1fr_1fr] gap-3 items-center text-[8px] text-slate-400 uppercase font-bold pb-1 mb-1 border-b border-white/10">
                                <span class="text-left">Date</span>
                                <span class="text-center">Sessions</span>
                                <span class="text-center">Questions</span>
                                <span class="text-center">Accuracy</span>
                                <span class="text-center">Score</span>
                                <span class="text-center">EXP</span>
                            </div>`;
                            sortedDailyStats.forEach(([dateStr, stats]) => {
                                const accuracy = stats.totalQ > 0 ? Math.round((stats.correctQ / stats.totalQ) * 100) : 0;
                                html += `<div class="grid grid-cols-[80px_1fr_1fr_1fr_1fr_1fr] gap-3 items-center text-[9px] text-slate-300 py-1.5 border-b border-white/5">
                                    <span class="text-left">${dateStr}</span>
                                    <span class="text-cyan-400 font-bold text-center">${stats.count} session${stats.count > 1 ? 's' : ''}</span>
                                    <span class="text-cyan-400 font-bold text-center">${stats.totalQ} Q</span>
                                    <span class="text-emerald-400 font-bold text-center">${accuracy}%</span>
                                    <span class="text-slate-400 font-bold text-center">${stats.correctQ}/${stats.totalQ}</span>
                                    <span class="text-indigo-400 font-bold text-center">+${stats.gainedExp} EXP</span>
                                </div>`;
                            });
                            dailyStatsEl.innerHTML = html;
                            dailyStatsEl.style.display = '';
                        } else {
                            dailyStatsEl.innerHTML = '<div class="text-[9px] text-slate-500/70 py-2 italic">No data available</div>';
                            dailyStatsEl.style.display = '';
                        }
                    }
                }
                renderPerformanceChart(userHistory);
            } catch (err) { console.error("Stats Error:", err); }
        }

        function renderPerformanceChart(history) {
            const ctx = getEl('performanceChart')?.getContext('2d');
            if (!ctx) return; if (chartInstance) chartInstance.destroy();
            const sortedData = [...history].sort((a, b) => a.timestamp - b.timestamp);
            const labels = ["START", ...sortedData.map(h => h.date || "")];
            const solved = [0]; const sessionAcc = [null]; const cumAcc = [null];
            let cumSolved = 0;
            sortedData.forEach(h => { 
                cumSolved += Math.round(parseFloat(h.totalQ) || 0); 
                solved.push(cumSolved); 
                let sNum = parseFloat(String(h.score).replace('%',''));
                if (sNum <= 1.0 && sNum > 0) sNum *= 100;
                sessionAcc.push(isNaN(sNum) ? null : Math.round(sNum)); 
                let aNum = parseFloat(String(h.avg10).replace('%',''));
                if (aNum <= 1.0 && aNum > 0) aNum *= 100;
                cumAcc.push(isNaN(aNum) ? null : Math.round(aNum));
            });
            const y1Max = Math.ceil((Math.max(...solved, 0) + 1) / 50) * 50;
            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ç´¯è¨ˆå•é¡Œæ•°', data: solved, borderColor: '#00f2ff', yAxisID: 'y1', tension: 0.4, fill: false, pointRadius: (ctx) => ctx.dataIndex === 0 ? 0 : 2, pointBackgroundColor: '#00f2ff', spanGaps: true, borderWidth: 1 },
                        { label: 'å˜å›æ­£è§£ç‡', data: sessionAcc, borderColor: '#f59e0b', borderWidth: 1, yAxisID: 'y2', tension: 0, pointRadius: 2, pointBackgroundColor: '#f59e0b', showLine: true, spanGaps: true },
                        { label: 'ç›´è¿‘10å›å¹³å‡', data: cumAcc, borderColor: accentColor, yAxisID: 'y2', tension: 0.2, pointRadius: 2, pointBackgroundColor: accentColor, borderWidth: 1, spanGaps: true }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { left: -5, right: 0, top: 60, bottom: 5 } }, 
                    scales: { 
                        x: { type: 'category', display: true, ticks: { color: '#64748b', font: { size: 9 }, autoSkip: true }, grid: { display: false }, offset: false }, 
                        y1: { type: 'linear', position: 'left', min: 0, max: y1Max, ticks: { color: '#00f2ff', stepSize: 50 }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y2: { 
                            type: 'linear', position: 'right', min: 0, max: 100, 
                            ticks: { color: '#f59e0b', stepSize: 20, callback: (v) => v + '' }, 
                            grid: { display: false } 
                        }
                    },
                    plugins: { legend: { display: false } } 
                }
            });
        }

        function parseTSVText(text, eraName) {
            if (!text) return [];
            return text.split(/\r?\n/).filter(l => l.trim() !== "").map((line, i) => {
                const cols = line.split('\t').map(c => c.trim().replace(/^"|"$/g, ''));
                if (cols[0] === "å•é¡Œ" || cols.length < 5) return null;
                let qRaw = cols[0].replace(/^[ï¼ˆ\(](åŸºç¤|æ¨™æº–|å¿œç”¨|ç™ºå±•)[ï¼‰\)]/, "").trim().replace(/([â‘ â‘¡â‘¢â‘£])/g, '<br>$1');
                let tag = cols[0].match(/^[ï¼ˆ\(](åŸºç¤|æ¨™æº–|å¿œç”¨|ç™ºå±•)[ï¼‰\)]/)?.[1] || "æ¨™æº–";
                let rawExpl = (cols[13] || cols[14] || "è©³ç´°è§£èª¬æº–å‚™ä¸­ã€‚");
                return { id: `${eraName}-${i + 1}`, era: eraName, question: qRaw, tag, options: [cols[1], cols[2], cols[3], cols[4]], answer: (parseInt(cols[10]) >= 1 && parseInt(cols[10]) <= 4) ? cols[parseInt(cols[10])] : cols[10], explanation: rawExpl.replace(/([â‘ â‘¡â‘¢â‘£])/g, '<br>$1') };
            }).filter(p => p !== null);
        }

        window.renderEraMenu = () => {
            const container = getEl('era-menu-container'); if(!container) return;
            let rawData = localStorage.getItem('nihonshi_data_main');
            
            // ä»¥å‰ã®å€«ç†ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚‚ç¢ºèª
            if (!rawData || rawData === '{}' || rawData === 'null') {
                const oldData = localStorage.getItem('nihonshi_tsv_ultra_main');
                if (oldData) {
                    console.log('ä»¥å‰ã®æ—¥æœ¬å²ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ç§»è¡Œã—ã¾ã™...');
                    localStorage.setItem('nihonshi_data_main', oldData);
                    rawData = oldData;
                }
            }
            
            let storedTSV = {};
            try {
                storedTSV = rawData ? JSON.parse(rawData) : {};
            } catch (e) {
                console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e, rawData);
                container.innerHTML = '<div class="text-[9px] text-red-400 text-center py-4 italic">ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºï¼‰
            console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ç”Ÿãƒ‡ãƒ¼ã‚¿:', rawData?.substring(0, 200));
            console.log('ãƒ‘ãƒ¼ã‚¹å¾Œã®storedTSV:', storedTSV);
            console.log('storedTSVã®å‹:', typeof storedTSV);
            console.log('storedTSVã®ã‚­ãƒ¼:', Object.keys(storedTSV));
            
            masterDataTotal = Object.entries(storedTSV).flatMap(([category, tsv]) => parseTSVText(tsv, category));
            container.innerHTML = '';
            
            // æ—¥æœ¬å²ã®åˆ†é‡ï¼ˆã‚·ãƒ¼ãƒˆåï¼‰ã®å®šç¾©é †åºï¼ˆå„ªå…ˆè¡¨ç¤ºé †ï¼‰
            const nihonshiCategoriesOrder = [
                'åŸå§‹ãƒ»å¤å¢³',
                'é£›é³¥ãƒ»å¥ˆè‰¯',
                'å¹³å®‰å‰æœŸ',
                'å¹³å®‰ä¸­æœŸãƒ»å¾ŒæœŸ',
                'éŒå€‰æ™‚ä»£',
                'å—åŒ—æœãƒ»å®¤ç”ºæ™‚ä»£',
                'æˆ¦å›½ãƒ»å®‰åœŸæ¡ƒå±±æ™‚ä»£',
                'æ±Ÿæˆ¸å‰æœŸï¼ˆå®¶åº·ã€œç¶±å‰ï¼‰',
                'æ±Ÿæˆ¸ä¸­æœŸï¼ˆäº«ä¿ã€œåŒ–æ”¿ï¼‰',
                'æ±Ÿæˆ¸æœ«æœŸï¼ˆå¹•æœ«ï¼‰',
                'æ˜æ²»ï¼ˆå‰æœŸã€œä¸­æœŸï¼‰',
                'æ˜æ²»ï¼ˆå¾ŒæœŸï¼‰ã€œå¤§æ­£',
                'æ˜­å’Œï¼ˆæˆ¦å‰ãƒ»æˆ¦ä¸­ï¼‰',
                'æ˜­å’Œï¼ˆæˆ¦å¾Œï¼‰ã€œå¹³æˆ',
                'æ³•åˆ¶ãƒ»æ”¿æ²»åˆ¶åº¦',
                'åœŸåœ°åˆ¶åº¦ãƒ»çµŒæ¸ˆå²',
                'å¤–äº¤å²',
                'å²æ–™å•é¡Œ',
                'ç¤¾ä¼šãƒ»æ°‘è¡†å²'
            ];
            
            // å…¨ã¦ã®ã‚·ãƒ¼ãƒˆåã‚’å–å¾—
            const allSheetNames = Object.keys(storedTSV);
            console.log('å–å¾—ã—ãŸã‚·ãƒ¼ãƒˆå:', allSheetNames);
            console.log('masterDataTotalã®ä»¶æ•°:', masterDataTotal.length);
            
            if (allSheetNames.length === 0) {
                const dataExists = rawData !== null && rawData !== '{}' && rawData !== '';
                const debugInfo = dataExists ? 'ãƒ‡ãƒ¼ã‚¿ã¯å­˜åœ¨ã—ã¾ã™ãŒã€ã‚·ãƒ¼ãƒˆåãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ' : 'ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                container.innerHTML = `
                    <div class="text-[9px] text-slate-500 text-center py-4 italic space-y-2">
                        <div>ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¦ãã ã•ã„</div>
                        <div class="text-red-400 text-[8px]">${debugInfo}<br>ã€ŒSyncã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„</div>
                        <div class="text-amber-400 text-[7px] mt-2">ãƒ‡ãƒãƒƒã‚°: ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼ˆF12 ã¾ãŸã¯ Cmd+Option+Iï¼‰ã®Consoleã‚¿ãƒ–ã§è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™<br>ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—: ${typeof storedTSV}, ã‚­ãƒ¼æ•°: ${allSheetNames.length}</div>
                    </div>
                `;
                return;
            }
            
            // å®šç¾©é †åºã®ã‚·ãƒ¼ãƒˆåã‚’å„ªå…ˆã—ã€æ®‹ã‚Šã‚’ã‚½ãƒ¼ãƒˆã—ã¦çµåˆ
            const orderedCategories = nihonshiCategoriesOrder.filter(cat => allSheetNames.includes(cat));
            const remainingCategories = allSheetNames.filter(cat => !nihonshiCategoriesOrder.includes(cat)).sort();
            const categories = [...orderedCategories, ...remainingCategories];
            
            const level = getEl('level-select').value;
            
            // å„åˆ†é‡ï¼ˆã‚·ãƒ¼ãƒˆåï¼‰ã‚’è¡¨ç¤º
            categories.forEach((categoryName) => {
                let categoryProblems = masterDataTotal.filter(d => d.era === categoryName);
                if (level === 'elementary') categoryProblems = categoryProblems.filter(q => ['åŸºç¤', 'æ¨™æº–'].includes(q.tag));
                else if (level === 'intermediate') categoryProblems = categoryProblems.filter(q => ['åŸºç¤', 'æ¨™æº–', 'å¿œç”¨'].includes(q.tag));
                
                const eHeader = document.createElement('div'); 
                eHeader.className = 'era-header'; 
                eHeader.innerHTML = `<span>${categoryName} <small class="opacity-50">(${categoryProblems.length})</small></span><i class="fas fa-chevron-right text-[10px]"></i>`;
                
                const eContent = document.createElement('div'); 
                eContent.className = 'era-content grid grid-cols-4 gap-1.5 p-2 max-h-0 overflow-hidden';
                
                if (categoryProblems.length > 0) {
                    for(let i=0; i<categoryProblems.length; i+=10) {
                        const rangeLabel = `${i+1}-${Math.min(i+10, categoryProblems.length)}`;
                        
                        // ã“ã®ç¯„å›²ã®å•é¡Œã‚»ãƒƒãƒˆã®å±¥æ­´ã‚’å–å¾—
                        const rangeHistory = userHistory.filter(h => 
                            h.summaryEra === categoryName && h.summaryRange === rangeLabel
                        );
                        const attemptCount = rangeHistory.length;
                        let lastAttemptDate = '';
                        if (rangeHistory.length > 0) {
                            // æœ€æ–°ã®æ—¥ä»˜ã‚’å–å¾—
                            const latest = rangeHistory.sort((a, b) => b.timestamp - a.timestamp)[0];
                            if (latest.date) {
                                const dateStr = latest.date;
                                // æ—¥ä»˜ã‚’æ•´å½¢ï¼ˆä¾‹: "01/15" â†’ "1/15", "01/05" â†’ "1/5"ï¼‰
                                const parts = dateStr.split('/');
                                lastAttemptDate = `${parseInt(parts[0])}/${parseInt(parts[1])}`;
                            }
                        }
                        
                        const btn = document.createElement('button'); 
                        btn.className = "bg-white/5 p-1.5 rounded-lg text-[8px] font-black min-h-[42px] flex flex-col items-center justify-center gap-0.5";
                        
                        // ãƒœã‚¿ãƒ³ã®å†…å®¹ã‚’æ§‹ç¯‰
                        let btnContent = `<span class="text-[9px]">${rangeLabel}</span>`;
                        if (attemptCount > 0) {
                            btnContent += `<span class="text-[7px] text-cyan-400 opacity-70">${attemptCount}å›</span>`;
                            if (lastAttemptDate) {
                                btnContent += `<span class="text-[7px] text-slate-400 opacity-60">${lastAttemptDate}</span>`;
                            }
                        }
                        btn.innerHTML = btnContent;
                        
                        btn.onclick = () => { 
                            currentSessionEra = categoryName; 
                            currentSessionRangeLabel = rangeLabel; 
                            quizData = categoryProblems.slice(i, i+10); 
                            startQuiz(); 
                        };
                        eContent.appendChild(btn);
                    }
                } else { 
                    eContent.innerHTML = '<div class="col-span-4 text-[8px] opacity-30 text-center py-2">NO DATA</div>'; 
                }
                
                eHeader.onclick = (ev) => { 
                    ev.stopPropagation(); 
                    eContent.classList.toggle('expanded'); 
                };
                
                container.appendChild(eHeader); 
                container.appendChild(eContent);
            });
        };

        function startQuiz() { currentIdx = 0; score = 0; streak = 0; sessionAnswers = []; getEl('home-screen').classList.add('hidden'); getEl('quiz-screen').classList.remove('hidden'); getEl('q-total').innerText = quizData.length; renderDots(); showQuestion(); }
        function showQuestion() { 
            canAnswer = true; const q = quizData[currentIdx]; getEl('q-current').innerText = currentIdx + 1; 
            getEl('current-accuracy').innerText = (currentIdx === 0 ? 0 : Math.round((score/currentIdx)*100)) + '%'; 
            getEl('current-streak').innerText = streak; getEl('diff-badge').innerText = `${q.era} | ${q.tag}`; 
            const statKey = q.id;
            const qs = questionStats[statKey] || { total: 0, correct: 0 }; 
            if(getEl('q-history-stat')) getEl('q-history-stat').innerText = `${qs.total === 0 ? 0 : Math.round((qs.correct / qs.total) * 100)}% (${qs.correct}/${qs.total})`; 
            let qText = q.question.replace(/æ­£ã—ã„/g, '<span class="text-emerald-400 font-bold">æ­£ã—ã„</span>').replace(/èª¤ã£ã¦ã„ã‚‹/g, '<span class="text-rose-400 font-bold">èª¤ã£ã¦ã„ã‚‹</span>');
            getEl('question-text').innerHTML = qText; 
            const oc = getEl('options-container'); oc.innerHTML = ''; 
            shuffleArray([...q.options]).forEach((opt) => { 
                const btn = document.createElement('button'); btn.className = "option-btn"; btn.innerHTML = `<span>${opt}</span>`; btn.onclick = () => handleAnswer(opt, btn); oc.appendChild(btn); 
            }); 
            getEl('feedback-area').classList.add('hidden'); window.scrollTo({ top: 0, behavior: 'smooth' }); 
        }
        
        async function handleAnswer(selected, btn) { 
            if (!canAnswer) return; canAnswer = false; const q = quizData[currentIdx]; const isCorrect = (selected === q.answer); sessionAnswers[currentIdx] = isCorrect; 
            const statKey = q.id;
            const exist = questionStats[statKey] || { total: 0, correct: 0 }; 
            questionStats[statKey] = { total: exist.total + 1, correct: exist.correct + (isCorrect ? 1 : 0), lastDate: Date.now() }; 
            if (isCorrect) { score++; streak++; getEl(`dot-${currentIdx}`).classList.add('dot-correct'); } 
            else { streak = 0; getEl(`dot-${currentIdx}`).classList.add('dot-wrong'); } 
            const btns = getEl('options-container').getElementsByTagName('button'); 
            for (let b of btns) { b.disabled = true; if (b.innerText.trim() === q.answer.trim()) b.classList.add('border-emerald-500', 'bg-emerald-500/20'); else if (b.innerText.trim() === selected.trim() && !isCorrect) b.classList.add('border-rose-500', 'bg-rose-500/20'); } 
            getEl('feedback-area').classList.remove('hidden'); getEl('explanation-content').innerHTML = q.explanation; getEl('result-badge').innerText = isCorrect ? 'CORRECT' : 'INCORRECT'; getEl('result-badge').className = "px-6 py-2 rounded-full text-[10px] font-black uppercase w-fit " + (isCorrect ? "bg-emerald-500" : "bg-rose-500"); 
            const voiceList = isCorrect ? praiseWords.perfect : praiseWords.low; getEl('voice-message').innerText = voiceList[Math.floor(Math.random() * voiceList.length)]; setTimeout(() => { getEl('feedback-area').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100); 
        }

        function renderDots() { const bar = getEl('dot-bar'); if(!bar) return; bar.innerHTML = ''; quizData.forEach((_, i) => { const d = document.createElement('div'); d.className = 'progress-dot'; d.id = `dot-${i}`; bar.appendChild(d); }); }
        function showModal(title, message) { const modal = getEl('custom-modal'); if(modal) { getEl('modal-title').innerText = title; getEl('modal-message').innerText = message; modal.classList.add('active'); } }

        function finishSession() {
            const oldExp = parseInt(getEl('total-neural-exp').innerText) || 0;
            const oldLv = Math.floor(oldExp / 10);
            getEl('quiz-screen').classList.add('hidden'); getEl('result-screen').classList.remove('hidden');
            const pct = Math.round((score / quizData.length) * 100); 
            logDetailedResultsToSpreadsheet(pct, score, quizData.length);
            getEl('final-score').innerText = pct; getEl('final-exp-gained').innerText = score;
            const newExp = oldExp + score;
            const newLv = Math.floor(newExp / 10);
            const lvUpMsg = getEl('level-up-msg');
            if (newLv > oldLv) { if (lvUpMsg) lvUpMsg.classList.remove('hidden'); } else { if (lvUpMsg) lvUpMsg.classList.add('hidden'); }
            const goalMsg = getEl('goal-eval-msg');
            if (pct >= selectedGoal) {
                goalMsg.innerText = "MISSION ACCOMPLISHED: Target Attained";
                goalMsg.className = "text-[10px] font-black uppercase tracking-[0.3em] mb-2 text-emerald-400";
            } else {
                goalMsg.innerText = "TARGET MISSED: " + selectedGoal + "% required";
                goalMsg.className = "text-[10px] font-black uppercase tracking-[0.3em] mb-2 text-rose-400";
            }
            const resKey = pct === 100 ? 'perfect' : pct >= 80 ? 'high' : pct >= 60 ? 'mid' : 'low';
            getEl('final-praise').innerText = praiseWords[resKey][Math.floor(Math.random() * praiseWords[resKey].length)];
            getEl('final-praise-jp').innerText = feedbackJP[resKey][Math.floor(Math.random() * feedbackJP[resKey].length)];
            getEl('final-icon').innerText = pct === 100 ? "ğŸ‘‘" : pct >= 80 ? "ğŸ¯" : pct >= 60 ? "ğŸ”‹" : "âš ï¸";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.showHome = () => { getEl('quiz-screen').classList.add('hidden'); getEl('result-screen').classList.add('hidden'); getEl('home-screen').classList.remove('hidden'); updateStatsUI(); window.renderEraMenu(); window.scrollTo({ top: 0, behavior: 'smooth' }); };
        
        window.abortQuiz = () => {
            if (confirm('æ¼”ç¿’ã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿé€²è¡ŒçŠ¶æ³ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚')) {
                // ã‚¯ã‚¤ã‚ºã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                currentIdx = 0;
                score = 0;
                streak = 0;
                sessionAnswers = [];
                quizData = [];
                canAnswer = true;
                // ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
                window.showHome();
            }
        };
        
        window.syncAllFromSpreadsheet = async (isAuto = false) => { 
            if (!FIXED_GAS_URL) return;
            
            // UIã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰URLã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ã€ãªã‘ã‚Œã°å›ºå®šURLã‚’ä½¿ç”¨
            const urlInput = getEl('main-spreadsheet-url');
            const spreadsheetUrl = urlInput && urlInput.value ? urlInput.value : FIXED_SPREADSHEET_URL;
            const sid = spreadsheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/)?.[1];
            
            if (!sid) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒå–å¾—ã§ãã¾ã›ã‚“:', spreadsheetUrl);
                if (!isAuto) showModal("Sync Error", "ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }
            
            try { 
                const syncUrl = `${FIXED_GAS_URL}?action=sync&id=${sid}&userId=${USER_NAME}`;
                console.log('åŒæœŸURL:', syncUrl);
                console.log('ä½¿ç”¨ä¸­ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL:', spreadsheetUrl);
                console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID:', sid);
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼å:', USER_NAME);
                
                const result = await fetchWithRetry(syncUrl); 
                console.log('åŒæœŸçµæœå…¨ä½“:', result);
                console.log('resultã®å…¨ã‚­ãƒ¼:', Object.keys(result));
                console.log('result.problems:', result.problems);
                console.log('result.problemsã®å‹:', typeof result.problems);
                console.log('result.problemsã®ã‚­ãƒ¼:', result.problems ? Object.keys(result.problems) : 'null');
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
                if (result.debug) {
                    console.log('=== ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
                    console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå†…ã®å…¨ã‚·ãƒ¼ãƒˆå:', result.debug.allSheetNames);
                    console.log('æœŸå¾…ã•ã‚Œã‚‹åˆ†é‡å (validUnits):', result.debug.validUnits);
                    console.log('ä¸€è‡´ã—ãªã‹ã£ãŸã‚·ãƒ¼ãƒˆå:', result.debug.unmatchedSheets);
                    console.log('å–å¾—ã§ããŸå•é¡Œãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼:', result.debug.problemsKeys);
                    console.log('==================');
                }
                
                // problemsã®ä¸­èº«ã‚’è©³ã—ãç¢ºèª
                if (result.problems) {
                    console.log('result.problemsã®è©³ç´°:', JSON.stringify(result.problems).substring(0, 500));
                    const problemKeys = Object.keys(result.problems);
                    console.log('å•é¡Œã‚­ãƒ¼ã®æ•°:', problemKeys.length);
                    if (problemKeys.length > 0) {
                        console.log('æœ€åˆã®ã‚­ãƒ¼:', problemKeys[0]);
                        console.log('æœ€åˆã®å€¤ã®ã‚µãƒ³ãƒ—ãƒ«:', typeof result.problems[problemKeys[0]], result.problems[problemKeys[0]]?.substring(0, 100));
                    }
                }
                
                if (result.problems) {
                    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèª
                    localStorage.setItem('nihonshi_data_main', JSON.stringify(result.problems));
                    console.log('ä¿å­˜å¾Œã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸:', localStorage.getItem('nihonshi_data_main')?.substring(0, 200));
                }
                if(result.userStats) { Object.entries(result.userStats).forEach(([key, s]) => { questionStats[key] = { total: parseInt(s.total) || 0, correct: parseInt(s.correct) || 0 }; }); }
                if(result.history) userHistory = result.history; if(result.ranking) rankingData = result.ranking;
                // é€£ç¶šæ­£è§£æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                window.currentStreak = result.currentStreak || 0;
                window.maxStreak = result.maxStreak || 0; 
                updateStatsUI(); window.renderEraMenu(); 
            } catch (e) { 
                console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', e);
                if (!isAuto) showModal("Sync Error", "ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã‚’ã”ç¢ºèªãã ã•ã„ã€‚"); 
            } 
        };
        
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

        const praiseWords = {
            perfect: ["ABSOLUTELY FLAWLESS!", "PURE GENIUS AT WORK!", "BEYOND EXCELLENT!", "TOTAL MASTERY ACHIEVED!", "HISTORICAL SUPREMACY!", "THE ULTIMATE SCHOLAR!", "PERFECT NEURAL SYNC!", "UNSTOPPABLE FORCE!", "LEGENDARY PERFORMANCE!", "MASTER OF HISTORY!", "INFINITE ACCURACY!", "ROYAL ACHIEVEMENT!", "BEYOND PERFECTION!", "DIVINE KNOWLEDGE!", "GODLIKE CONCENTRATION!", "HISTORIA MAXIMA!", "ELITE LEVEL REACHED!", "TOTAL DOMINATION!", "FLAWLESS EXECUTION!", "TRUE HISTORY MASTER!"],
            high: ["AMAZING PRECISION!", "OUTSTANDING WORK!", "ELITE PERFORMANCE!", "BRIGHT FUTURE AHEAD!", "STUNNING RESULTS!", "HIGH-SPEED SYNC!", "EXCEPTIONAL KNOWLEDGE!", "TOP-TIER ANALYSIS!", "BRILLIANT EFFORT!", "ALMOST PERFECT!", "SUPERIOR STRATEGY!", "GREAT MOMENTUM!", "SOLID EXAM-READY!", "REMARKABLE PROGRESS!", "SHARP INTELLECT!", "KEEP THIS ENERGY!", "PROFESSIONAL LEVEL!", "EXCELLENT BALANCE!", "POWERFUL INSIGHT!", "NEAR-MASTERY!"],
            mid: ["STEADY PROGRESS!", "KEEP PUSHING FORWARD!", "STAY FOCUSED!", "SOLID FOUNDATION!", "GROWING STRONGER!", "NEURAL LINK ACTIVE!", "GOOD MOMENTUM!", "ANALYZE AND CONQUER!", "ALMOST THERE!", "STAY SHARP!", "CONSISTENT EFFORT!", "STAY VIGILANT!", "BATTLE CONTINUES!", "GAIN MORE DATA!", "EVOLVING SCHOLAR!", "KNOWLEDGE LOADING...", "KEEP THE FIRE!", "REACH FOR TOP!", "UNFOLD THE TRUTH!", "PROCESS ONGOING!"],
            low: ["NEVER GIVE UP!", "FOCUS REQUIRED!", "STAY THE COURSE!", "RE-SYNC IMMINENT!", "ANALYZE ERRORS!", "STAY DETERMINED!", "KEEP SEARCHING!", "BUILD THE BASE!", "TRY ONCE MORE!", "KNOWLEDGE HUNTER!", "DEFIANT LEARNING!", "KEEP GRINDING!", "FUTURE IS OPEN!", "STAY HUMBLE!", "RISE ABOVE!", "STRENGTH IN PRACTICE!", "SHATTER THE LIMIT!", "REBOOT YOUR MIND!", "EMBRACE THE CHALLENGE!", "STAY BRAVE!"]
        };

        const feedbackJP = {
            perfect: ["ç´ æ™´ã‚‰ã—ã„ï¼åŠªåŠ›ãŒå®Œç’§ãªå½¢ã«ãªã‚Šã¾ã—ãŸã€‚è‡ªä¿¡ã‚’æŒã£ã¦çªãé€²ã‚“ã§ãã ã•ã„ã€‚", "å…¨å•æ­£è§£ï¼ã‚ãªãŸã®é›†ä¸­åŠ›ã¨çŸ¥è­˜ã®æ·±ã•ã¯ã€åˆæ ¼ã¸ã®ç¢ºã‹ãªæ­¦å™¨ã«ãªã‚Šã¾ã™ã€‚", "éã®æ‰“ã¡æ‰€ãŒãªã„æˆæœã§ã™ã€‚ä»Šã®ãƒšãƒ¼ã‚¹ã‚’å´©ã•ãšã€ç€å®Ÿã«ã‚´ãƒ¼ãƒ«ã¸è¿‘ã¥ãã¾ã—ã‚‡ã†ã€‚", "å®Œç’§ãªåŒæœŸã§ã™ï¼ã“ã®æ„Ÿè¦šã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã€æ—¥ã€…ã®æ¼”ç¿’ã‚’å¤§åˆ‡ã«ã—ã¦ãã ã•ã„ã€‚", "è‡³é«˜ã®æ­£ç­”ç‡ã§ã™ã€‚å­¦ã‚“ã§ããŸæ™‚é–“ã¯ã€æ±ºã—ã¦ã‚ãªãŸã‚’è£åˆ‡ã‚Šã¾ã›ã‚“ã€‚", "è¦‹äº‹ãªæº€ç‚¹ï¼åŸºç¤ãŒå®Œç’§ã«å›ºã¾ã£ã¦ã„ã¾ã™ã€‚å¿œç”¨å•é¡Œã‚‚ã“ã®èª¿å­ã§æ”»ç•¥ã—ã¾ã—ã‚‡ã†ã€‚", "åœ§å€’çš„ãªå®ŸåŠ›ã§ã™ã­ã€‚ä»Šã®ã‚ãªãŸã«æ­»è§’ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ¬ç•ªã‚’æƒ³å®šã—ãŸæ¼”ç¿’ã‚’ã€‚", "åŠªåŠ›ã®å¤©æ‰ã§ã™ã€‚æº€ç‚¹ã‚’å–ã‚‹ã®ã¯ç°¡å˜ãªã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è‡ªåˆ†ã‚’èª‡ã‚Šã«æ€ã£ã¦ã€‚", "ã“ã®100ï¼…ã¯ç©ã¿ä¸Šã’ã¦ããŸæ™‚é–“ã®çµæ™¶ã§ã™ã€‚è‡ªä¿¡ã‚’èƒ¸ã«ã€æ¬¡ã¸é€²ã¿ã¾ã—ã‚‡ã†ã€‚", "ç´ æ™´ã‚‰ã—ã„ï¼ä¸€å•ä¸€å•ã‚’å¤§åˆ‡ã«è§£ãå§¿å‹¢ãŒã“ã®çµæœã‚’ç”Ÿã¿ã¾ã—ãŸã€‚åˆæ ¼ã¯è¿‘ã„ã§ã™ã€‚", "ãŠè¦‹äº‹ï¼çŸ¥è­˜ã®ç‚¹ã¨ç‚¹ãŒç¹‹ãŒã‚Šã€é¢ã¨ãªã£ã¦å®šç€ã—ã¦ã„ã¾ã™ã€‚ãã®èª¿å­ï¼", "å®Œç’§ãªæ­£è§£ç‡ã€‚æš—è¨˜ã ã‘ã§ãªãã€æ­´å²ã®æµã‚Œã‚’ã—ã£ã‹ã‚Šæ´ã‚ã¦ã„ã‚‹è¨¼æ‹ ã§ã™ã€‚", "æ–‡å¥ãªã—ã®ãƒˆãƒƒãƒ—æˆç¸¾ï¼ã“ã®ç²¾åº¦ã‚’ç¶­æŒã§ãã‚Œã°ã€å¿—æœ›æ ¡ã¸ã®é“ã¯æ˜ã‚‹ã„ã§ã™ã‚ˆã€‚", "æœ€é«˜ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ç–²ã‚Œã‚’æ„Ÿã˜ãŸã¨ãã¯ã€ã“ã®çµæœã‚’è¦‹ã¦è‡ªä¿¡ã‚’å–ã‚Šæˆ»ã—ã¦ã€‚", "ã‚ãªãŸã¯ç€å®Ÿã«é€²åŒ–ã—ã¦ã„ã¾ã™ã€‚æº€ç‚¹ã¯ã€ã‚ãªãŸã®æ­£ã—ã„å­¦ç¿’æ³•ã®è¨¼æ˜ã§ã™ã€‚", "ç´ æ™´ã‚‰ã—ã„é›†ä¸­åŠ›ï¼è©¦é¨“ä¼šå ´ã§ã‚‚ã“ã®ã‚¾ãƒ¼ãƒ³ã«å…¥ã‚Œã‚‹ã‚ˆã†ã€ç·´ç¿’ã‚’é‡ã­ã¾ã—ã‚‡ã†ã€‚", "ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼æ­´å²ã®è¨¼äººã¨ã—ã¦ã€å…¨ã¦ã®å‡ºæ¥äº‹ã‚’å®Œç’§ã«æŠŠæ¡ã§ãã¦ã„ã¾ã™ã€‚", "æ„Ÿå‹•çš„ãªæ­£ç­”ç‡ï¼ã‚ãªãŸã®ç†±æ„ãŒãƒ‡ãƒ¼ã‚¿ã«åæ˜ ã•ã‚Œã¦ã„ã¾ã™ã€‚ãšã£ã¨å¿œæ´ã—ã¦ã„ã¾ã™ã€‚", "æºã‚‹ããªã„çŸ¥è­˜ã€‚ã¾ã•ã«ãƒã‚¹ã‚¿ãƒ¼ã®é ˜åŸŸã§ã™ã€‚è‡ªä¿¡ã‚’ã•ã‚‰ã«æ·±ã‚ã¦ã„ãã¾ã—ã‚‡ã†ï¼", "å®Œç’§ã§ã™ï¼ä»Šæ—¥å¾—ãŸã“ã®ã€Œæ­£è§£ã®æ„Ÿè¦šã€ã‚’å¤§åˆ‡ã«ã€æ˜æ—¥ã®å­¦ç¿’ã«ç¹‹ã’ã¦ãã ã•ã„ã€‚"],
            high: ["éå¸¸ã«å„ªç§€ãªãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚é–“é•ãˆãŸä¸€å•ã¯ã€æœ¬ç•ªã§å¾—ç‚¹ã™ã‚‹ãŸã‚ã®ã€Œå®ç‰©ã€ã§ã™ã€‚", "åˆæ ¼åœå†…ã®å®ŸåŠ›ã‚’ç¶­æŒã§ãã¦ã„ã¾ã™ã€‚ç´°ã‹ãªç©´ã‚’åŸ‹ã‚ã‚‹ã“ã¨ã§ã•ã‚‰ã«ç›¤çŸ³ã«ã€‚", "ç´ æ™´ã‚‰ã—ã„æ­£ç­”ç‡ï¼ã‚ã¨ä¸€æ­©ã§å®Œç’§ã§ã™ã€‚é–“é•ãˆãŸéƒ¨åˆ†ã‚’ä¸å¯§ã«ã•ã‚‰ã£ã¦ãŠã“ã†ã€‚", "å®‰å®šæ„ŸãŒã‚ã‚Šã¾ã™ã­ã€‚æœ¬ç•ªã§ã‚‚ã“ã®å†·é™ã•ã‚’ä¿ã¦ã‚Œã°ã€å¿…ãšè‰¯ã„çµæœãŒã€‚ ", "ç€å®Ÿã«åŠ›ãŒã¤ã„ã¦ã„ã¾ã™ã€‚å‡ºæ¥äº‹ã‚’ã€Œãªãœã€ã¨ã„ã†è¦–ç‚¹ã§è¦‹ç›´ã™ã¨ã•ã‚‰ã«ä¼¸ã³ã¾ã™ã€‚", "é«˜ã‚¹ã‚³ã‚¢ã§ã™ï¼åŠªåŠ›ã¯ç¢ºå®Ÿã«å½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚æ²¹æ–­ã›ãšã€ã“ã®èª¿å­ã§é€²ã‚‚ã†ã€‚", "ç´ æ™´ã‚‰ã—ã„æˆæœã§ã™ã€‚é–“é•ãˆãŸå•é¡Œã®è§£èª¬ã‚’èª­ã¿è¾¼ã¿ã€è‡ªåˆ†ã®ã‚‚ã®ã«ã—ã¾ã—ã‚‡ã†ã€‚", "å„ªç§€ã§ã™ï¼åŸºç¤çŸ¥è­˜ãŒã—ã£ã‹ã‚Šæ ¹ä»˜ã„ã¦ã„ã¾ã™ã€‚æ¬¡ã¯æº€ç‚¹ã‚’ç›®æŒ‡ã—ã¦æŒ‘æˆ¦ã‚’ã€‚", "ã“ã®ã‚¹ã‚³ã‚¢ã¯è‡ªä¿¡ã«ã—ã¦è‰¯ã„ã§ã™ã‚ˆã€‚æ®‹ã‚Šã®å¾®èª¿æ•´ãŒã€å¤§ããªå¾—ç‚¹å·®ã«ãªã‚Šã¾ã™ã€‚", "é«˜ã„æ°´æº–ã‚’ä¿ã¦ã¦ã„ã¾ã™ã­ã€‚æ¯æ—¥ã®ç©ã¿é‡ã­ãŒã€ã‚ãªãŸã®å®ŸåŠ›ã‚’æŠ¼ã—ä¸Šã’ã¾ã—ãŸã€‚", "è¦‹äº‹ãªæ­£ç­”ç‡ã€‚é–“é•ãˆãŸç®‡æ‰€ã¯ã€è¨˜æ†¶ã‚’ã•ã‚‰ã«å¼·åŒ–ã™ã‚‹ãŸã‚ã®ãƒãƒ£ãƒ³ã‚¹ã§ã™ã€‚", "å®‰å®šã—ãŸæˆç¸¾ã§ã™ã­ã€‚å­¦ç¿’ãƒªã‚ºãƒ ã¯éå¸¸ã«è‰¯ã„çŠ¶æ…‹ã§ã™ã€‚ã“ã®ã¾ã¾çªãé€²ãŠã†ï¼", "ç´ æ™´ã‚‰ã—ã„ï¼ç†è§£ãŒæ·±ã¾ã£ã¦ã„ã‚‹ã®ãŒã‚ˆãåˆ†ã‹ã‚Šã¾ã™ã€‚æµã‚Œã‚’å†ç¢ºèªã—ã¦ç›¤çŸ³ã«ã€‚", "ã‚ã¨å°‘ã—ã§æº€ç‚¹ï¼ãã®æƒ…ç†±ãŒã‚ã‚Œã°ã€ã©ã‚“ãªå£ã‚‚ä¹—ã‚Šè¶Šãˆã‚‰ã‚Œã¾ã™ã€‚é ‘å¼µã‚ã†ï¼", "å„ªç§€ãªãƒ‡ãƒ¼ã‚¿åŒæœŸã§ã™ã€‚é–“é•ãˆãŸå•é¡Œã¯ã€ä»Šã®ã†ã¡ã«æ°—ã¥ã‘ã¦è‰¯ã‹ã£ãŸã¨è€ƒãˆã‚ˆã†ã€‚", "é †èª¿ã«å®ŸåŠ›ã‚’ä¼¸ã°ã—ã¦ã„ã¾ã™ã­ã€‚é ‘å¼µã‚Šã‚’ä¸€ç•ªçŸ¥ã£ã¦ã„ã‚‹ã®ã¯ã‚¢ãƒ—ãƒªã®è¨˜éŒ²ã§ã™ã€‚", "é«˜å¾—ç‚¹ã§ã™ï¼æœ¬ç•ªã§ã‚‚ã“ã®ç²¾åº¦ã§è§£ã‘ã‚Œã°åˆæ ¼ã¯è¿‘ã¥ãã¾ã™ã€‚å¿œæ´ã—ã¦ã„ã¾ã™ã€‚", "çŸ¥è­˜ã®å®šç€åº¦ãŒéå¸¸ã«é«˜ã„ã§ã™ã€‚ã•ã‚‰ã«ä¸Šã‚’ç›®æŒ‡ã™å§¿å‹¢ãŒæœ€é«˜ã®çµæœã‚’å‘¼ã³ã¾ã™ã€‚", "ç´ æ™´ã‚‰ã—ã„ï¼ã“ã®èª¿å­ã§æ¼”ç¿’ã‚’é‡ã­ã€è‹¦æ‰‹ãªæ™‚ä»£ã‚’ä¸€ã¤ãšã¤æ¶ˆã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚", "å®‰å®šã—ãŸã‚¹ã‚³ã‚¢ã€‚æ—¥é ƒã®åŠªåŠ›ãŒå®ŸåŠ›ã¨ã—ã¦å®šç€ã—ã¦ã„ã¾ã™ã€‚ä¸€æ­©ä¸€æ­©ã€è‡ªä¿¡ã‚’ï¼"],
            mid: ["ä¸€æ­©ãšã¤ã€ç¢ºå®Ÿã«æˆé•·ã—ã¦ã„ã¾ã™ã­ã€‚åŸºç¤ã¯å›ºã¾ã‚Šã¾ã—ãŸã€‚æ¬¡ã¯å¿œç”¨åŠ›ã‚’ç£¨ã“ã†ã€‚", "ç€å®Ÿã«å‰é€²ã—ã¦ã„ã¾ã™. é–“é•ãˆãŸå•é¡Œã“ãã€ã‚ãªãŸã®å®ŸåŠ›ã‚’ä¼¸ã°ã™éµã«ãªã‚Šã¾ã™ã€‚", "æ‰‹å¿œãˆã‚’æ„Ÿã˜å§‹ã‚ã¦ã„ã‚‹ã¯ãšã€‚ä»Šã¯çŸ¥è­˜ã‚’ç¹‹ãåˆã‚ã›ã‚‹æ™‚æœŸã€‚ç„¦ã‚‰ãšé€²ã‚“ã§ã€‚", "åŠåˆ†ä»¥ä¸Šã¯æ­£è§£ã§ãã¦ã„ã¾ã™ã€‚æ®‹ã‚Šã¯ã‚‚ã†ä¸€åº¦æ•™ç§‘æ›¸ã‚’è¦‹ç›´ã™ã ã‘ã§è§£æ±ºã—ã¾ã™ã€‚", "åŠªåŠ›ã®æˆæœãŒè¦‹ãˆå§‹ã‚ã¦ã„ã¾ã™ã€‚æ¯æ—¥å°‘ã—ãšã¤ã®ç©ã¿é‡ã­ãŒå¤§ããªåŠ›ã«å¤‰ã‚ã‚‹ã€‚", "ç²˜ã‚Šå¼·ãé ‘å¼µã£ã¦ã„ã¾ã™ã­ã€‚ã“ã®ã‚¹ã‚³ã‚¢ã¯ã€ã‚ãªãŸãŒæŒ‘æˆ¦ã—ç¶šã‘ã¦ã„ã‚‹è¨¼æ‹ ã§ã™ã€‚", "å¤§ä¸ˆå¤«ã€ä¼¸ã³ä»£ã¯ãŸã£ã·ã‚Šã‚ã‚Šã¾ã™ã€‚ä»Šã®æ‚”ã—ã•ã‚’ãƒãƒã«ã€æ¬¡ã¯ã‚‚ã£ã¨é«˜å¾—ç‚¹ã‚’ã€‚", "åŸºç¤ãƒ–ãƒ­ãƒƒã‚¯ã®å†æ§‹ç¯‰ãŒå¿…è¦ã§ã™ã€‚é–“é•ãˆãŸæ™‚ä»£ã®æµã‚Œã‚’ç‰©èªã®ã‚ˆã†ã«èª­ã¿è¿”ãã†ã€‚", "ç€å®Ÿãªé€²æ­©ã§ã™ã€‚å¾—æ„ãªæ™‚ä»£ã‚’ä¸€ã¤ä½œã‚Šã€ãã“ã‹ã‚‰åºƒã’ã‚‹ã®ãŒåˆæ ¼ã¸ã®è¿‘é“ã§ã™ã€‚", "å­¦ç¿’ã®æˆæœãŒå‡ºã¦ã„ã¾ã™ã€‚ç†è§£ã§ãã¦ã„ã‚‹éƒ¨åˆ†ã¯è‡ªä¿¡ã‚’æŒã¡ã€æ›–æ˜§ãªéƒ¨åˆ†ã¯ä»Šã€‚ ", "ä¸€æ­©ä¸€æ­©ã€éšæ®µã‚’ä¸Šã£ã¦ã„ã¾ã™ã€‚ä»Šã®åŠªåŠ›ã¯å¿…ãšæœ¬ç•ªã§ã‚ãªãŸã‚’åŠ©ã‘ã¦ãã‚Œã¾ã™ã€‚", "å‰å‘ãã«ã„ãã¾ã—ã‚‡ã†ï¼æ¼”ç¿’ã‚’ç¹°ã‚Šè¿”ã™ã”ã¨ã«çŸ¥è­˜ã®ç¶²ç›®ã¯ç´°ã‹ããªã£ã¦ã„ãã¾ã™ã€‚", "åŸºç¤ã¯ã§ãã¦ã„ã¾ã™ã€‚ç”¨èªåŒå£«ã®ç¹‹ãŒã‚Šã‚’æ„è­˜ã™ã‚‹ã¨ã€æ­£ç­”ç‡ã¯è·³ã­ä¸ŠãŒã‚Šã¾ã™ã€‚", "ä»Šã®é ‘å¼µã‚ŠãŒæœªæ¥ã®ã‚ãªãŸã‚’ä½œã‚Šã¾ã™ã€‚é–“é•ãˆãŸå•é¡Œã‚’å‹é”ã ã¨æ€ã£ã¦å‘ãåˆã£ã¦ã€‚", "åˆæ ¼ã¸ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ­©ã‚“ã§ã„ã¾ã™ã€‚ç‚¹æ•°ã«ä¸€å–œä¸€æ†‚ã›ãšã€å†…å®¹ã®ç†è§£ã‚’å„ªå…ˆã—ã¦ã€‚", "å­¦ç¿’ã®ãƒªã‚ºãƒ ã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ä»Šæ—¥ã§ããªã‹ã£ãŸã“ã¨ã¯æ˜æ—¥ã§ãã‚Œã°è‰¯ã„ã€‚", "ç€å®Ÿãªæ­©ã¿ã§ã™. æ­´å²ã®å…¨ä½“åƒãŒè¦‹ãˆå§‹ã‚ã¦ã„ã¾ã™ã€‚æè‘‰ã‚’è¶³ã™ä½œæ¥­ã«å…¥ã‚ã†ã€‚", "æˆé•·ã®çœŸã£æœ€ä¸­ã«ã„ã¾ã™ã€‚è«¦ã‚ãšã«ç¹°ã‚Šè¿”ã™ã“ã¨ã§ã€æ™¯è‰²ã¯å¿…ãšå¤‰ã‚ã‚Šã¾ã™ã‚ˆã€‚", "æ‰‹å¿œãˆã‚’ä¿¡ã˜ã¦ãã ã•ã„ã€‚ä»Šã¯ç‚¹æ•°ã‚ˆã‚Šã‚‚è§£èª¬ã‚’èª­ã‚“ã§ç´å¾—ã™ã‚‹ã“ã¨ã‚’å¤§åˆ‡ã«ã€‚", "é ‘å¼µã£ã¦ã„ã¾ã™ã­ã€‚ä¸€å•æ­£è§£ã™ã‚‹ã”ã¨ã«ä»¥å‰ã®è‡ªåˆ†ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚å¿œæ´ã—ã¦ã‚‹ï¼"],
            low: ["ç„¦ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šã¯çŸ¥è­˜ã®ç©´ã‚’è¦‹ã¤ã‘ã‚‹æœ€é«˜ã®ãƒãƒ£ãƒ³ã‚¹ã€‚ä¸€ã¤ãšã¤ã€‚ ", "ã¾ãšã¯åŸºç¤å˜èªã‹ã‚‰å†ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚åœŸå°ãŒã—ã£ã‹ã‚Šã™ã‚Œã°ç‚¹æ•°ã¯ä¼¸ã³ã‚‹ã€‚", "ãƒªãƒ³ã‚¯ãŒå°‘ã—ä¸å®‰å®šãªã ã‘. ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã‚‚ã†ä¸€åº¦è§£èª¬ã‚’èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚", "ã“ã“ãŒè¸ã‚“å¼µã‚Šã©ã“ã‚. ä¸€ã¤ãšã¤ä¸å¯§ã«ç†è§£ã‚’æ·±ã‚ã‚Œã°ã€å¿…ãšæ™¯è‰²ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚", "ä»Šã¯é–“é•ã„ã‚’æã‚Œãšæ¼”ç¿’ã—ã¾ã—ã‚‡ã†ã€‚ãã®æ‚”ã—ã•ãŒã€æœ¬ç•ªã®å¾—ç‚¹ã«ç¹‹ãŒã‚Šã¾ã™ã€‚", "ä¼¸ã³ä»£ã¯ç„¡é™å¤§ï¼ã¾ãšã¯ä¸€ç•ªå¥½ããªæ™‚ä»£ã‹ã‚‰é›†ä¸­çš„ã«å¾©ç¿’ã—ã¦ã¿ã‚‹ã®ã¯ã©ã†ï¼Ÿ ", "æ­´å²ã®æµã‚Œã‚’ã–ã£ã¨æ´ã‚€ã¨ã“ã‚ã‹ã‚‰å†é–‹ã—ã¾ã—ã‚‡ã†ã€‚ç‰©èªã‚’æ¥½ã—ã‚€æ°—æŒã¡ã§ã€‚ ", "ã‚ãªãŸã¯ä»Šã€ä¸€ç•ªè‹¦ã—ã„æ™‚æœŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã«ã¯æŒ‘æˆ¦ãŒå¿…è¦ã§ã™ã€‚", "ç‚¹æ•°ã§ã¯ãªãã€ä»Šæ—¥æ–°ã—ãçŸ¥ã£ãŸã€ŒçŸ¥è­˜ã€ã«æ³¨ç›®. ä¸€æ­©ãšã¤å‰ã¸é€²ã‚ã°å¤§ä¸ˆå¤«ã€‚", "å¤§ä¸ˆå¤«ã§ã™ã€‚ã©ã‚“ãªåäººã‚‚ã€æœ€åˆã¯ä»Šã®ã‚ãªãŸã¨åŒã˜å ´æ‰€ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ãŸã€‚ ", "é–“é•ãˆãŸåˆ†ã ã‘ã€å¼·ããªã‚Œã¾ã™ã€‚è§£èª¬ã‚’ã€Œãªã‚‹ã»ã©ã€ã¨æ€ã†ã¾ã§èª­ã¿è¿”ã—ã¦ã€‚ ", "æ·±å‘¼å¸ã—ã¦ã€ã‚‚ã†ä¸€åº¦åŸºç¤ã«ç«‹ã¡è¿”ã‚Šã¾ã—ã‚‡ã†ã€‚æ€¥ãŒã°å›ã‚ŒãŒæœ€çŸ­ãƒ«ãƒ¼ãƒˆã§ã™ã€‚", "è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§å¤§ä¸ˆå¤«. ä»–äººã¨æ¯”ã¹ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ˜¨æ—¥ã‚’è¶…ãˆã¦ã„ã“ã†ã€‚", "çŸ¥è­˜ã‚’æ•´ç†ã™ã‚‹ãƒãƒ£ãƒ³ã‚¹ã§ã™ã€‚å¹´è¡¨ã‚’ä¸€åº¦è‡ªåˆ†ã§æ›¸ã„ã¦ã¿ã‚‹ã¨é©šãã»ã©é€²ã¿ã¾ã™ã€‚", "è«¦ã‚ãªã„ã§ã€‚ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ã‚ãªãŸãŒå†ã³ç«‹ã¡ä¸ŠãŒã‚‹ã®ã‚’ä½•åº¦ã§ã‚‚ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã€‚", "ã¾ãšã¯ä¸€ã¤ç¢ºå®Ÿã«è¦šãˆã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã‚ˆã†ã€‚ãã®ç©ã¿é‡ã­ãŒå·¨å¤§ãªåŠ›ã«ãªã‚Šã¾ã™ã€‚", "æ­´å²ã¯ç¹‹ãŒã‚Šã§ã™ã€‚æ–­ç‰‡çš„ãªçŸ¥è­˜ã‚’ã€æ™‚ä»£ã¨ã„ã†ç³¸ã§ç¹‹ãç›´ã™ä½œæ¥­ã‚’ä»Šã—ã‚ˆã†ã€‚", "ã‚ãªãŸã®æŒ‘æˆ¦è‡ªä½“ãŒç´ æ™´ã‚‰ã—ã„ã€‚ä»Šæ—¥ã®çµæœã‚’åˆ†æã—ã¦æ˜æ—¥ã®ç³§ã«ã—ã¦ãã ã•ã„ã€‚", "å°‘ã—ãšã¤ã§ã„ã„ã€‚æ•™ç§‘æ›¸ã‚’1ãƒšãƒ¼ã‚¸èª­ã‚€ã ã‘ã§ä¸–ç•Œã¯æ˜¨æ—¥ã‚ˆã‚ŠåºƒãŒã£ã¦ã„ã¾ã™ã€‚", "è² ã‘ãªã„ã§. ã‚ãªãŸã®ã€Œåˆæ ¼ã—ãŸã„ã€ã¨ã„ã†æ°—æŒã¡ã‚’ã€å¿ƒã‹ã‚‰å¿œæ´ã—ã¦ã„ã¾ã™ï¼"]
        };

        window.onload = () => { 
            initUserInfo(); 
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆURLã‚’è¨­å®š
            const urlInput = getEl('main-spreadsheet-url');
            if (urlInput && (!urlInput.value || urlInput.value.trim() === '')) {
                urlInput.value = FIXED_SPREADSHEET_URL;
            }
            
            const themeGrid = getEl('theme-grid');
            if (themeGrid) {
                Object.entries(THEMES).forEach(([id, t]) => {
                    const swatch = document.createElement('div');
                    swatch.id = `swatch-${id}`;
                    swatch.className = 'theme-swatch';
                    swatch.style.background = t.accent;
                    swatch.title = id;
                    swatch.onclick = () => applyTheme(id);
                    themeGrid.appendChild(swatch);
                });
            }
            const savedTheme = localStorage.getItem('historia_theme_mode') || 'modeA';
            applyTheme(savedTheme);
            window.syncAllFromSpreadsheet(true); 
            setOnClick('next-btn-action', () => { currentIdx++; if (currentIdx < quizData.length) showQuestion(); else finishSession(); }); 
            setOnClick('sync-all-btn-action', () => window.syncAllFromSpreadsheet(false)); 
            setOnClick('cloud-sync-toggle-btn', () => { const area = getEl('sync-area'); if (area) area.classList.toggle('hidden'); }); 
        };
    </script>
</body>
</html>
